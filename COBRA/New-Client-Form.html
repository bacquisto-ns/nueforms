<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NueSynergy New Client Onboarding</title>
  
  <!-- Performance: Preload critical resources -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style">
  <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
  
  <!-- CSS Frameworks & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Animation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <style>
    :root {
      /* Primary Brand Colors */
      --primary-blue: #1E4E6B;
      --primary-blue-light: #2a5f7a;
      
      /* Accent Colors */
      --accent-green: #A4C639;
      --accent-green-hover: #8fb332;
      
      /* Text Colors */
      --text-primary: #2d3748;
      --text-secondary: #64748b;
      
      /* Background Colors */
      --bg-primary: #f0f4f8;
      --bg-secondary: #e8f2f6;
      --bg-card: #ffffff;
      --border-default: #e2e8f0;
    }
    html, body { height: 100%; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%); 
      color: var(--text-primary); 
    }
    .card { 
      background: white; 
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(30, 78, 107, 0.1); 
      transition: all 0.3s ease;
    }
    .step-active { display: block; }
    .step-hidden { display: none; }
    .sig-pad { border: 2px solid rgba(164, 198, 57, 0.8); border-radius: 8px; background: white; }
    .progress { 
      height: 8px; 
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%); 
      border-radius: 999px; 
      overflow: hidden; 
    }
    .progress > div { 
      height: 100%; 
      background: linear-gradient(90deg, var(--accent-green) 0%, var(--accent-green-hover) 100%); 
      transition: width 0.5s ease; 
      position: relative;
    }
    .dot { 
      width: 30px; 
      height: 30px; 
      border-radius: 999px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 0.75rem; 
      transition: all 0.3s ease;
      border: 2px solid var(--border-default);
    }
    /* Accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    /* Form Input Styles */
    input[type="text"],
    input[type="email"],
    input[type="date"],
    input[type="number"],
    input[type="file"],
    select,
    textarea {
      border-color: var(--border-default);
      transition: all 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-green) !important;
      box-shadow: 0 0 0 3px rgba(164, 198, 57, 0.1) !important;
      transform: translateY(-1px);
      outline: none;
    }
    input[type="checkbox"],
    input[type="radio"] {
      accent-color: var(--accent-green);
    }
    /* File Input Buttons */
    input[type="file"]::file-selector-button {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      margin-right: 1rem;
      transition: opacity 0.3s ease;
    }
    input[type="file"]::file-selector-button:hover {
      opacity: 0.9;
    }
    /* Journey Tracker Styles */
    .process-visualization {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(30, 78, 107, 0.1);
    }
    .journey-step {
      position: relative;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.5rem 1rem;
      transition: all 0.3s ease;
      cursor: default;
      overflow: hidden;
    }
    .journey-step::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, transparent, var(--accent-green), transparent);
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }
    .journey-step:hover::before {
      transform: translateX(100%);
    }
    .journey-icon-wrapper {
      position: relative;
      width: 60px;
      height: 60px;
      margin: 0 auto 1rem;
      background: linear-gradient(135deg, #f0f4f0 0%, #e5e7eb 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .journey-icon {
      font-size: 1.5rem;
      color: #6b7280;
      transition: all 0.3s ease;
    }
    .journey-number {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .journey-checkmark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 70px;
      height: 70px;
      background: var(--accent-green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 2;
    }
    .journey-checkmark i {
      color: white;
      font-size: 1.75rem;
      font-weight: bold;
    }
    .journey-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
      text-align: center;
    }
    .journey-description {
      font-size: 0.75rem;
      color: #9ca3af;
      line-height: 1.3;
      transition: all 0.3s ease;
      text-align: center;
    }
    /* ACTIVE STATE */
    .journey-step.active {
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);
      border-color: var(--accent-green);
      box-shadow: 0 8px 24px rgba(164, 198, 57, 0.3);
      transform: translateY(-4px);
    }
    .journey-step.active .journey-icon-wrapper {
      background: rgba(255, 255, 255, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }
    .journey-step.active .journey-icon {
      color: white;
      transform: scale(1.1);
    }
    .journey-step.active .journey-number {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      box-shadow: 0 4px 12px rgba(30, 78, 107, 0.4);
    }
    .journey-step.active .journey-title,
    .journey-step.active .journey-description {
      color: white;
    }
    /* COMPLETED STATE */
    .journey-step.completed {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      border-color: var(--primary-blue);
      box-shadow: 0 4px 16px rgba(30, 78, 107, 0.2);
    }
    .journey-step.completed .journey-icon-wrapper {
      background: rgba(255, 255, 255, 0.2);
    }
    .journey-step.completed .journey-icon {
      color: rgba(255, 255, 255, 0.5);
    }
    .journey-step.completed .journey-checkmark {
      transform: translate(-50%, -50%) scale(1);
    }
    .journey-step.completed .journey-checkmark.hidden {
      display: flex !important;
    }
    .journey-step.completed .journey-number {
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);
    }
    .journey-step.completed .journey-title,
    .journey-step.completed .journey-description {
      color: white;
    }
    /* PENDING STATE */
    .journey-step.pending {
      opacity: 0.7;
    }
    .journey-step.pending:hover {
      opacity: 0.85;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    /* Shimmer Animation */
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(200%); }
    }
    .animate-shimmer {
      animation: shimmer 2s infinite;
    }
    /* Animations */
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
      }
    }
    /* Journey Tracker Responsive */
    @media (max-width: 768px) {
      .journey-step {
        padding: 1rem 0.75rem;
      }
      .journey-icon-wrapper {
        width: 50px;
        height: 50px;
      }
      .journey-icon {
        font-size: 1.25rem;
      }
      .journey-number {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
      }
      .journey-title {
        font-size: 0.85rem;
      }
      .journey-description {
        font-size: 0.7rem;
      }
      .journey-checkmark {
        width: 55px;
        height: 55px;
      }
      .journey-checkmark i {
        font-size: 1.5rem;
      }
    }
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      .card { box-shadow: none; border: 1px solid #ddd; border-radius: 0; }
      .sig-pad { border: 1px solid #ccc; }
      body { background: #fff; color: #000; }
    }
  </style>
</head>
<body>
  <div class="min-h-full">
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-white focus:text-blue-600 focus:rounded">Skip to main content</a>
    
    <!-- Screen Reader Announcements -->
    <div id="status-message" class="sr-only" role="status" aria-live="polite"></div>
    <div id="error-message" class="sr-only" role="alert" aria-live="assertive"></div>
    
    <header class="relative overflow-hidden animate-in" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col sm:flex-row items-center sm:items-start gap-4 text-white">
          <img alt="NueSynergy" src="https://nuesynergy.com/wp-content/uploads/2023/02/nuesynergy_logo.png" class="h-10 w-auto bg-white/0" />
          <div class="text-center sm:text-left">
            <h1 class="text-2xl sm:text-3xl font-bold drop-shadow">NueSynergy</h1>
            <p class="opacity-90 text-sm mt-1">EMPLOYEE FOCUSED ASSISTANCE</p>
            <p class="opacity-80 text-xs mt-1">
              <i class="fas fa-phone mr-1"></i>1-800-413-4138 | 
              <i class="fas fa-envelope ml-2 mr-1"></i>info@nuesynergy.com
            </p>
          </div>
        </div>
        <h2 class="mt-4 text-xl font-semibold" style="color: var(--accent-green);">
          <i class="fas fa-file-contract mr-2"></i>New Client Onboarding
        </h2>
      </div>
    </header>

    <main id="main-content" class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 mt-5">
      <div class="card p-6 sm:p-8">
        <!-- Interactive Journey Tracker -->
        <nav role="navigation" aria-label="Form progress" class="mb-8">
          <div class="process-visualization animate-in" id="journey-tracker">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
              <div>
                <h3 class="text-2xl font-bold flex items-center" style="color: var(--primary-blue);">
                  <i class="fas fa-route mr-3 text-3xl"></i>Your Journey
                </h3>
                <p class="text-sm mt-1 ml-0 sm:ml-12" style="color: var(--text-secondary);">Track your progress through the form</p>
              </div>
              <div class="text-left sm:text-right">
                <span class="text-3xl font-bold" style="color: var(--accent-green);" id="progressText">Step 1</span>
                <p class="text-sm" style="color: var(--text-secondary);">of 6 steps</p>
              </div>
            </div>
            
            <!-- Animated Progress Bar -->
            <div class="relative w-full bg-gray-200 rounded-full h-3 mb-8 overflow-hidden">
              <div class="h-3 rounded-full transition-all duration-700 ease-out relative" 
                   id="progressBar" 
                   style="width: 16.67%; background: linear-gradient(90deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-shimmer"></div>
              </div>
            </div>
            
            <!-- Interactive Step Cards -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
              <!-- Step 1: Company -->
              <div class="journey-step active" id="journey-step-1" data-step="1">
                <div class="journey-step-inner">
                  <div class="journey-icon-wrapper">
                    <i class="fas fa-building journey-icon"></i>
                    <div class="journey-checkmark hidden">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                  <div class="journey-number">1</div>
                  <h4 class="journey-title">Company</h4>
                  <p class="journey-description">Group details</p>
                </div>
              </div>
              
              <!-- Step 2: Contacts -->
              <div class="journey-step pending" id="journey-step-2" data-step="2">
                <div class="journey-step-inner">
                  <div class="journey-icon-wrapper">
                    <i class="fas fa-users journey-icon"></i>
                    <div class="journey-checkmark hidden">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                  <div class="journey-number">2</div>
                  <h4 class="journey-title">Contacts</h4>
                  <p class="journey-description">Key people</p>
                </div>
              </div>
              
              <!-- Step 3: Plans -->
              <div class="journey-step pending" id="journey-step-3" data-step="3">
                <div class="journey-step-inner">
                  <div class="journey-icon-wrapper">
                    <i class="fas fa-clipboard-list journey-icon"></i>
                    <div class="journey-checkmark hidden">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                  <div class="journey-number">3</div>
                  <h4 class="journey-title">Plans</h4>
                  <p class="journey-description">Coverage setup</p>
                </div>
              </div>
              
              <!-- Step 4: Population -->
              <div class="journey-step pending" id="journey-step-4" data-step="4">
                <div class="journey-step-inner">
                  <div class="journey-icon-wrapper">
                    <i class="fas fa-users-cog journey-icon"></i>
                    <div class="journey-checkmark hidden">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                  <div class="journey-number">4</div>
                  <h4 class="journey-title">Population</h4>
                  <p class="journey-description">Files & data</p>
                </div>
              </div>
              
              <!-- Step 5: Billing -->
              <div class="journey-step pending" id="journey-step-5" data-step="5">
                <div class="journey-step-inner">
                  <div class="journey-icon-wrapper">
                    <i class="fas fa-credit-card journey-icon"></i>
                    <div class="journey-checkmark hidden">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                  <div class="journey-number">5</div>
                  <h4 class="journey-title">Billing</h4>
                  <p class="journey-description">Payment info</p>
                </div>
              </div>
              
              <!-- Step 6: Authorization -->
              <div class="journey-step pending" id="journey-step-6" data-step="6">
                <div class="journey-step-inner">
                  <div class="journey-icon-wrapper">
                    <i class="fas fa-signature journey-icon"></i>
                    <div class="journey-checkmark hidden">
                      <i class="fas fa-check"></i>
                    </div>
                  </div>
                  <div class="journey-number">6</div>
                  <h4 class="journey-title">Authorize</h4>
                  <p class="journey-description">Sign & submit</p>
                </div>
              </div>
            </div>
          </div>
        </nav>

        <form id="ncForm" class="space-y-10">
          <!-- Step 1: Company & Group Details (nc1) -->
          <section data-step="1" class="step step-active">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-semibold flex items-center gap-2" style="color: var(--primary-blue);">
                <i class="fas fa-building"></i>
                Company & Group Details
              </h3>
              <a class="text-xs underline hover:opacity-80 transition-opacity" style="color: var(--primary-blue);" href="new-client/nc1.png" target="_blank" rel="noreferrer">View reference layout</a>
            </div>
            <p class="mb-5" style="color: var(--text-secondary);">Provide employer details and services to be implemented.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium" style="color: var(--text-primary);">Employer/Group Name <span class="text-red-500">*</span></label>
                <input name="employer_name" required class="mt-1 block w-full rounded-md border-2 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium" style="color: var(--text-primary);">Employer FEIN</label>
                <input name="fein" class="mt-1 block w-full rounded-md border-2 px-3 py-2" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700">Address</label>
                <input name="address1" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">City</label>
                <input name="city" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">State</label>
                <input name="state" maxlength="2" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2 uppercase" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Zip</label>
                <input name="zip" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Effective Date <span class="text-red-500">*</span></label>
                <input type="date" name="effective_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>

            <div class="mt-6">
              <span class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Services to Implement</span>
              <div class="flex flex-wrap gap-4 text-sm">
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="svc_cobra" class="h-4 w-4" /> COBRA Administration</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="svc_fsa" class="h-4 w-4" /> FSA</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="svc_hra" class="h-4 w-4" /> HRA</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="svc_hsa" class="h-4 w-4" /> HSA</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="svc_commuter" class="h-4 w-4" /> Commuter</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="svc_other" data-toggle-other="#svc_other_text" class="h-4 w-4" /> Other</label>
                <input id="svc_other_text" name="svc_other_text" placeholder="Specify other" class="border-2 border-slate-200 rounded px-3 py-2 text-sm disabled:bg-slate-100" disabled />
              </div>
            </div>
          </section>

          <!-- Step 2: Contacts (nc2) -->
          <section data-step="2" class="step step-hidden">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-semibold flex items-center gap-2" style="color: var(--primary-blue);">
                <i class="fas fa-users"></i>
                Contacts & Communication
              </h3>
              <a class="text-xs underline hover:opacity-80 transition-opacity" style="color: var(--primary-blue);" href="new-client/nc2.png" target="_blank" rel="noreferrer">View reference layout</a>
            </div>
            <p class="mb-5" style="color: var(--text-secondary);">Provide primary, billing, and broker contacts.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="md:col-span-1">
                <h4 class="font-semibold" style="color: var(--primary-blue);">Primary Admin Contact <span class="text-red-500">*</span></h4>
                <div class="mt-2 space-y-3">
                  <input name="contact_primary_name" placeholder="Full Name" required class="block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  <input type="email" name="contact_primary_email" placeholder="Email" required class="block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  <input name="contact_primary_phone" placeholder="Phone" class="block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
              </div>
              <div class="md:col-span-1">
                <h4 class="font-semibold" style="color: var(--primary-blue);">Billing Contact</h4>
                <div class="mt-2 space-y-3">
                  <input name="contact_billing_name" placeholder="Full Name" class="block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  <input type="email" name="contact_billing_email" placeholder="Email" class="block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  <input name="contact_billing_phone" placeholder="Phone" class="block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
              </div>
              <div class="md:col-span-1">
                <h4 class="font-semibold" style="color: var(--primary-blue);">Broker Contact</h4>
                <div class="mt-2 space-y-3">
                  <input name="contact_broker_name" placeholder="Full Name" class="block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  <input type="email" name="contact_broker_email" placeholder="Email" class="block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  <input name="contact_broker_phone" placeholder="Phone" class="block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
              </div>
            </div>

            <div class="mt-6">
              <label class="text-sm" style="color: var(--text-primary);">Preferred Communication Method</label>
              <div class="mt-2 flex flex-wrap gap-4 text-sm">
                <label class="inline-flex items-center gap-2"><input type="radio" name="comm_pref" value="email" class="h-4 w-4" checked /> Email</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="comm_pref" value="phone" class="h-4 w-4" /> Phone</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="comm_pref" value="portal" class="h-4 w-4" /> Portal</label>
              </div>
            </div>
          </section>

          <!-- Step 3: Plan Setup (nc3) -->
          <section data-step="3" class="step step-hidden">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-semibold flex items-center gap-2" style="color: var(--primary-blue);">
                <i class="fas fa-clipboard-list"></i>
                Plan Setup
              </h3>
              <a class="text-xs underline hover:opacity-80 transition-opacity" style="color: var(--primary-blue);" href="new-client/nc3.png" target="_blank" rel="noreferrer">View reference layout</a>
            </div>
            <p class="mb-5" style="color: var(--text-secondary);">List active plans and carrier details. Include group numbers, deductibles, coverage tiers, and if applicable COBRA premiums.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Medical -->
              <div class="rounded-lg border-2 border-slate-200 p-4">
                <label class="flex items-center gap-3 font-semibold" style="color: var(--primary-blue);">
                  <input type="checkbox" name="plan_medical" class="h-5 w-5" /> Medical
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Carrier</label>
                    <input name="medical_carrier" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Group Number</label>
                    <input name="medical_group" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Deductible</label>
                    <input name="medical_deductible" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Monthly COBRA Premium</label>
                    <input name="medical_premium" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                </div>
                <div class="mt-3">
                  <span class="block text-sm mb-1" style="color: var(--text-primary);">Coverage Tier</span>
                  <div class="flex flex-wrap gap-3 text-sm items-center">
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="employee_only" class="h-4 w-4" /> Employee Only</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="ee_spouse" class="h-4 w-4" /> EE + Spouse</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="ee_children" class="h-4 w-4" /> EE + Child(ren)</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="family" class="h-4 w-4" /> Family</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="other" data-tier-radio data-other-input-id="medical_tier_other" class="h-4 w-4" /> Other</label>
                    <input type="text" id="medical_tier_other" name="medical_tier_other" placeholder="Specify other" class="border-2 border-slate-200 rounded px-3 py-2 disabled:bg-slate-100" disabled />
                  </div>
                </div>
              </div>

              <!-- Dental -->
              <div class="rounded-lg border-2 border-slate-200 p-4">
                <label class="flex items-center gap-3 font-semibold" style="color: var(--primary-blue);">
                  <input type="checkbox" name="plan_dental" class="h-5 w-5" /> Dental
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Carrier</label>
                    <input name="dental_carrier" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Group Number</label>
                    <input name="dental_group" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Deductible</label>
                    <input name="dental_deductible" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Monthly COBRA Premium</label>
                    <input name="dental_premium" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                </div>
                <div class="mt-3">
                  <span class="block text-sm mb-1" style="color: var(--text-primary);">Coverage Tier</span>
                  <div class="flex flex-wrap gap-3 text-sm items-center">
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="employee_only" class="h-4 w-4" /> Employee Only</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="ee_spouse" class="h-4 w-4" /> EE + Spouse</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="ee_children" class="h-4 w-4" /> EE + Child(ren)</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="family" class="h-4 w-4" /> Family</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="other" data-tier-radio data-other-input-id="dental_tier_other" class="h-4 w-4" /> Other</label>
                    <input type="text" id="dental_tier_other" name="dental_tier_other" placeholder="Specify other" class="border-2 border-slate-200 rounded px-3 py-2 disabled:bg-slate-100" disabled />
                  </div>
                </div>
              </div>

              <!-- Vision -->
              <div class="rounded-lg border-2 border-slate-200 p-4">
                <label class="flex items-center gap-3 font-semibold" style="color: var(--primary-blue);">
                  <input type="checkbox" name="plan_vision" class="h-5 w-5" /> Vision
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Carrier</label>
                    <input name="vision_carrier" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Group Number</label>
                    <input name="vision_group" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Deductible</label>
                    <input name="vision_deductible" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Monthly COBRA Premium</label>
                    <input name="vision_premium" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                </div>
                <div class="mt-3">
                  <span class="block text-sm mb-1" style="color: var(--text-primary);">Coverage Tier</span>
                  <div class="flex flex-wrap gap-3 text-sm items-center">
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="employee_only" class="h-4 w-4" /> Employee Only</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="ee_spouse" class="h-4 w-4" /> EE + Spouse</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="ee_children" class="h-4 w-4" /> EE + Child(ren)</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="family" class="h-4 w-4" /> Family</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="other" data-tier-radio data-other-input-id="vision_tier_other" class="h-4 w-4" /> Other</label>
                    <input type="text" id="vision_tier_other" name="vision_tier_other" placeholder="Specify other" class="border-2 border-slate-200 rounded px-3 py-2 disabled:bg-slate-100" disabled />
                  </div>
                </div>
              </div>

              <!-- FSA/HRA/HSA details -->
              <div class="rounded-lg border-2 border-slate-200 p-4">
                <label class="flex items-center gap-3 font-semibold" style="color: var(--primary-blue);">
                  <input type="checkbox" name="plan_fsa" class="h-5 w-5" /> FSA
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Annual Max</label>
                    <input name="fsa_annual_max" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Employer Contribution</label>
                    <input name="fsa_employer_contrib" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Grace/Carryover</label>
                    <input name="fsa_grace" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="e.g., $640 carryover" />
                  </div>
                </div>
                <div class="mt-3 text-xs text-slate-600">If transitioning mid-year, include current balances in Files step.</div>
              </div>
            </div>
          </section>

          <!-- Step 4: Population & Files (nc4) -->
          <section data-step="4" class="step step-hidden">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-semibold flex items-center gap-2" style="color: var(--primary-blue);">
                <i class="fas fa-users-cog"></i>
                Population & Required Files
              </h3>
              <a class="text-xs underline hover:opacity-80 transition-opacity" style="color: var(--primary-blue);" href="new-client/nc4.png" target="_blank" rel="noreferrer">View reference layout</a>
            </div>
            <p class="mb-5" style="color: var(--text-secondary);">Provide counts and upload supporting documentation.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Total Employees</label>
                <input type="number" min="0" step="1" name="total_employees" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Active COBRA Participants <span class="text-red-500">*</span></label>
                <input type="number" min="0" step="1" name="active_cobra" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Pending Elections</label>
                <input type="number" min="0" step="1" name="pending_elections" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium" style="color: var(--text-primary);">Participant Roster (CSV/XLSX/PDF) <span class="text-red-500">*</span></label>
                <input id="file_roster" type="file" accept=".csv,.xlsx,.xls,.pdf" class="mt-1 block w-full text-sm" required />
                <p class="text-xs mt-1" style="color: var(--text-secondary);">Include current COBRA participants, dependents, coverage tier, and premium amounts.</p>
              </div>
              <div>
                <label class="block text-sm font-medium" style="color: var(--text-primary);">Rate Sheets / Carrier Bills (PDF) <span class="text-red-500">*</span></label>
                <input id="file_rates" type="file" accept=".pdf" class="mt-1 block w-full text-sm" required />
              </div>
              <div>
                <label class="block text-sm font-medium" style="color: var(--text-primary);">Plan Documents / SBCs (PDF)</label>
                <input id="file_plan_docs" type="file" accept=".pdf" multiple class="mt-1 block w-full text-sm" />
              </div>
              <div>
                <label class="block text-sm font-medium" style="color: var(--text-primary);">Additional Documents</label>
                <input id="file_additional" type="file" multiple class="mt-1 block w-full text-sm" />
              </div>
            </div>
          </section>

          <!-- Step 5: Billing & Banking (nc5) -->
          <section data-step="5" class="step step-hidden">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-semibold flex items-center gap-2" style="color: var(--primary-blue);">
                <i class="fas fa-credit-card"></i>
                Billing & Banking
              </h3>
              <a class="text-xs underline hover:opacity-80 transition-opacity" style="color: var(--primary-blue);" href="new-client/nc5.png" target="_blank" rel="noreferrer">View reference layout</a>
            </div>
            <p class="mb-5" style="color: var(--text-secondary);">Configure billing preferences and optional ACH information.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Billing Frequency</label>
                <select name="billing_frequency" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2">
                  <option value="monthly">Monthly</option>
                  <option value="biweekly">Bi-Weekly</option>
                  <option value="weekly">Weekly</option>
                  <option value="quarterly">Quarterly</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Billing Delivery Method</label>
                <select name="billing_delivery" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2">
                  <option value="email">Email</option>
                  <option value="portal">Portal</option>
                  <option value="mail">Mail</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700">Remittance Address</label>
                <input name="remit_address" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="If different from company address" />
              </div>
            </div>

            <div class="mt-6 rounded-lg border-2 border-slate-200 p-4 bg-slate-50">
              <h4 class="font-semibold" style="color: var(--primary-blue);">Optional ACH for Credits/Settlements</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-2">
                <div>
                  <label class="block text-sm font-medium text-slate-700">Bank Name</label>
                  <input name="bank_name" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700">Routing Number</label>
                  <input name="routing_number" inputmode="numeric" pattern="[0-9]*" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700">Account Number (stored as last 4)</label>
                  <input id="account_number" name="account_number" inputmode="numeric" autocomplete="off" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="••••1234" />
                  <input type="hidden" id="account_number_last4" name="account_number_last4" />
                </div>
              </div>
            </div>
          </section>

          <!-- Step 6: Authorization & Submit -->
          <section data-step="6" class="step step-hidden">
            <h3 class="text-xl font-semibold text-center flex items-center justify-center gap-2" style="color: var(--primary-blue);">
              <i class="fas fa-signature"></i>
              Authorization & Submission
            </h3>
            <p class="text-center mb-5" style="color: var(--text-secondary);">Please review, sign, and submit.</p>

            <div class="space-y-4">
              <div class="rounded-lg border-2 border-slate-200 p-4 bg-slate-50">
                <p class="text-sm text-slate-700">By signing below, I certify that I am authorized to provide onboarding information on behalf of the Employer/Group listed and that the information submitted is accurate to the best of my knowledge.</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-medium text-slate-700">Authorized Signer Full Name <span class="text-red-500">*</span></label>
                  <input name="auth_full_name" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700">Title</label>
                  <input name="auth_title" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700">Date <span class="text-red-500">*</span></label>
                  <input type="date" name="auth_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Signature <span class="text-red-500">*</span></label>
                <canvas id="sigPad" class="sig-pad w-full h-48"></canvas>
                <div class="mt-2 flex gap-2">
                  <button type="button" id="sigClear" class="px-3 py-2 rounded text-white text-sm font-medium transition-all" style="background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);">
                    <i class="fas fa-eraser mr-1"></i>Clear
                  </button>
                </div>
              </div>
              <div class="flex items-start gap-3 mt-3">
                <input id="ack" type="checkbox" class="mt-1 h-4 w-4" required />
                <label for="ack" class="text-sm" style="color: var(--text-primary);">I acknowledge NueSynergy will process onboarding according to provided documentation and will contact the primary contact if clarification is needed.</label>
              </div>
            </div>
          </section>

          <!-- Confirmation -->
          <section data-step="7" class="step step-hidden">
            <div class="text-center">
              <div class="mx-auto w-20 h-20 rounded-full flex items-center justify-center text-white text-3xl font-bold" style="background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);">
                <i class="fas fa-check"></i>
              </div>
              <h3 class="mt-4 text-2xl font-semibold" style="color: var(--primary-blue);">Submission Received</h3>
              <p class="mt-2" style="color: var(--text-secondary);">Thank you. Your onboarding details were submitted successfully.</p>
              <div id="submissionSummary" class="mt-6 text-left mx-auto max-w-2xl p-4 bg-slate-50 rounded border" style="border-color: var(--border-default);"></div>
              <div class="mt-6 flex flex-wrap items-center justify-center gap-3">
                <button type="button" onclick="window.print()" class="px-4 py-2 rounded-lg border-2 font-medium transition-all hover:transform hover:-translate-y-0.5" style="border-color: var(--primary-blue); color: var(--primary-blue);">
                  <i class="fas fa-print mr-2"></i>Print
                </button>
                <button type="button" id="downloadJsonBtn" class="px-4 py-2 rounded-lg text-white font-medium transition-all hover:transform hover:-translate-y-0.5" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);">
                  <i class="fas fa-download mr-2"></i>Download Data (JSON)
                </button>
                <button type="button" id="startOverBtn" class="px-4 py-2 rounded-lg text-white font-medium transition-all hover:transform hover:-translate-y-0.5" style="background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);">
                  <i class="fas fa-redo mr-2"></i>Start New
                </button>
              </div>
            </div>
          </section>

          <!-- Nav -->
          <div class="mt-6 pt-6 border-t flex items-center justify-between no-print" style="border-color: var(--border-default);">
            <button type="button" id="prevBtn" class="px-6 py-3 rounded-lg text-white font-semibold transition-all shadow-md hover:shadow-lg hover:transform hover:-translate-y-0.5" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);">
              <i class="fas fa-arrow-left mr-2"></i>Previous
            </button>
            <div class="flex items-center gap-2">
              <button type="button" id="skipBtn" class="hidden px-4 py-2 rounded border-2" style="border-color: var(--primary-blue); color: var(--primary-blue);">Skip</button>
              <button type="button" id="nextBtn" class="px-6 py-3 rounded-lg text-white font-semibold transition-all shadow-md hover:shadow-lg hover:transform hover:-translate-y-0.5" style="background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);">
                Next<i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </form>
      </div>

      <div class="print-only text-center mt-6">
        <h1 class="text-2xl font-bold" style="color: var(--primary-blue);">NueSynergy: New Client Onboarding</h1>
        <p style="color: var(--text-secondary);">Generated on <span id="printDate"></span></p>
      </div>
    </main>
  </div>

  <script>
    'use strict';
    
    (function() {
      // Accessibility: Screen reader announcements
      function announceToScreenReader(message) {
        const statusEl = document.getElementById('status-message');
        if (statusEl) {
          statusEl.textContent = message;
          setTimeout(() => { statusEl.textContent = ''; }, 1000);
        }
      }

      function announceError(message) {
        const errorEl = document.getElementById('error-message');
        if (errorEl) {
          errorEl.textContent = message;
          setTimeout(() => { errorEl.textContent = ''; }, 3000);
        }
      }
      
      // Initialize animations on page load
      function initAnimeAnimations() {
        if (typeof anime === 'undefined') return;
        
        // Animate header on load
        anime({
          targets: 'header.animate-in',
          opacity: [0, 1],
          translateY: [-30, 0],
          duration: 1200,
          easing: 'easeOutExpo'
        });
        
        // Animate main content card
        anime({
          targets: '.card',
          opacity: [0, 1],
          translateY: [30, 0],
          duration: 1000,
          delay: 300,
          easing: 'easeOutExpo'
        });
        
        // Animate journey tracker
        anime({
          targets: '#journey-tracker',
          opacity: [0, 1],
          translateY: [30, 0],
          duration: 1000,
          delay: 500,
          easing: 'easeOutExpo'
        });
        
        // Animate journey step cards with stagger
        anime({
          targets: '.journey-step',
          opacity: [0, 1],
          translateY: [30, 0],
          scale: [0.9, 1],
          delay: anime.stagger(80, {start: 800}),
          duration: 800,
          easing: 'easeOutElastic(1, .6)'
        });
      }
      
      // Run animations on load
      document.addEventListener('DOMContentLoaded', function() {
        initAnimeAnimations();
        announceToScreenReader('Form loaded and ready');
      });
      
      // Main form logic
      const form = document.getElementById('ncForm');
      const steps = Array.from(document.querySelectorAll('section.step'));
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');

      let currentStep = 1;
      const totalSteps = 7; // 6 steps + complete

      // Signature Pad (initialized on step 6)
      const sigCanvas = document.getElementById('sigPad');
      let sigPad;
      function initSigPad() {
        if (!sigCanvas || sigPad) return;
        sigPad = new SignaturePad(sigCanvas, {
          backgroundColor: 'rgba(255,255,255,1)',
          penColor: 'rgb(0,0,0)',
          minWidth: 1.0,
          maxWidth: 2.5,
        });
        const clearBtn = document.getElementById('sigClear');
        clearBtn?.addEventListener('click', () => sigPad.clear());
        function resize() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          sigCanvas.width = sigCanvas.offsetWidth * ratio;
          sigCanvas.height = sigCanvas.offsetHeight * ratio;
          sigCanvas.getContext('2d').scale(ratio, ratio);
        }
        window.addEventListener('resize', resize);
        resize();
      }

      function updateJourneySteps(step) {
        // Update progress text
        if (progressText) {
          progressText.textContent = `Step ${step}`;
        }
        
        // Update journey step cards
        for (let i = 1; i <= 6; i++) {
          const journeyStep = document.getElementById(`journey-step-${i}`);
          if (journeyStep) {
            journeyStep.className = 'journey-step';
            
            if (i < step) {
              journeyStep.classList.add('completed');
              // Animate checkmark appearance
              if (typeof anime !== 'undefined') {
                const checkmark = journeyStep.querySelector('.journey-checkmark');
                if (checkmark) {
                  anime({
                    targets: checkmark,
                    scale: [0, 1.2, 1],
                    rotate: [0, 360],
                    duration: 600,
                    delay: i * 100,
                    easing: 'easeOutElastic(1, .6)'
                  });
                }
              }
            } else if (i === step) {
              journeyStep.classList.add('active');
              // Pulse active step
              if (typeof anime !== 'undefined') {
                anime({
                  targets: journeyStep,
                  scale: [1, 1.05, 1],
                  duration: 600,
                  easing: 'easeInOutQuad'
                });
              }
            } else {
              journeyStep.classList.add('pending');
            }
          }
        }
      }

      function showStep(n) {
        steps.forEach((s,i) => {
          s.classList.toggle('step-active', i+1 === n);
          s.classList.toggle('step-hidden', i+1 !== n);
        });
        
        // Animate step transition
        const currentStepEl = steps[n-1];
        if (currentStepEl && typeof anime !== 'undefined') {
          anime({
            targets: currentStepEl,
            opacity: [0, 1],
            translateX: [50, 0],
            duration: 600,
            easing: 'easeOutExpo'
          });
        }
        
        prevBtn.style.visibility = n === 1 ? 'hidden' : 'visible';
        if (n < totalSteps) {
          nextBtn.innerHTML = n === totalSteps - 1 ? 
            '<i class="fas fa-paper-plane mr-2"></i>Submit' : 
            'Next<i class="fas fa-arrow-right ml-2"></i>';
        }
        if (n === totalSteps) nextBtn.classList.add('hidden'); else nextBtn.classList.remove('hidden');
        
        // Animate progress bar
        if (typeof anime !== 'undefined' && progressBar) {
          anime({
            targets: progressBar,
            width: ((n-1)/(totalSteps-1))*100 + '%',
            duration: 1000,
            easing: 'easeInOutQuad'
          });
        } else if (progressBar) {
          progressBar.style.width = ((n-1)/(totalSteps-1))*100 + '%';
        }
        
        updateJourneySteps(n);
        if (n === 6) setTimeout(initSigPad, 50);
        if (n === 7) document.getElementById('printDate').textContent = new Date().toLocaleString();
        
        // Scroll to top smoothly
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Announce to screen readers
        announceToScreenReader(`Step ${n} of ${totalSteps}`);
      }

      // Enable/disable generic "Other" text inputs driven by checkbox
      document.addEventListener('change', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLInputElement)) return;
        if (target.matches('[data-tier-radio]')) {
          const groupName = target.name;
          const otherInputId = target.getAttribute('data-other-input-id');
          const otherInput = otherInputId ? document.getElementById(otherInputId) : null;
          const selected = document.querySelector(`input[name="${groupName}"]:checked`);
          const isOther = selected && selected.value === 'other';
          if (otherInput) {
            otherInput.disabled = !isOther;
            if (!isOther) otherInput.value = '';
          }
        }
        if (target.matches('[data-toggle-other]')) {
          const inputSel = target.getAttribute('data-toggle-other');
          const otherInput = inputSel ? document.querySelector(inputSel) : null;
          if (otherInput) {
            otherInput.disabled = !target.checked;
            if (!target.checked) otherInput.value = '';
          }
        }
      });

      function validateStep(n) {
        const stepEl = steps[n-1];
        if (!stepEl) return true;
        const required = Array.from(stepEl.querySelectorAll('[required]'));
        let ok = true;
        required.forEach(inp => {
          const visible = inp.offsetParent !== null;
          if (!visible) return;
          const empty = inp.type === 'checkbox' ? !inp.checked : !String(inp.value||'').trim();
          inp.classList.toggle('ring-2', empty);
          inp.classList.toggle('ring-red-500', empty);
          if (empty) ok = false;
        });
        if (n === 4) {
          const roster = document.getElementById('file_roster');
          const rates = document.getElementById('file_rates');
          if (!roster.files.length || !rates.files.length) ok = false;
        }
        if (n === 6) {
          const ack = document.getElementById('ack');
          if (!ack.checked) ok = false;
          if (sigPad && sigPad.isEmpty()) ok = false;
        }
        return ok;
      }

      // Mask/stash account number last4
      const acctInput = document.getElementById('account_number');
      const acctHidden = document.getElementById('account_number_last4');
      function maskAccount(value) {
        const digits = (value || '').replace(/\D/g, '').slice(0, 17);
        const last4 = digits.slice(-4);
        if (acctHidden) acctHidden.value = last4;
        return last4 ? `••••${last4}` : '';
      }
      if (acctInput) {
        acctInput.addEventListener('input', (e) => {
          const v = e.target.value;
          e.target.value = maskAccount(v);
        });
        acctInput.addEventListener('blur', (e) => {
          e.target.value = maskAccount(e.target.value);
        });
      }

      async function toJSONPayload() {
        const data = new FormData(form);
        const payload = {
          formType: 'new_client_onboarding',
          submissionTimestamp: new Date().toISOString(),
          company: {
            employer_name: data.get('employer_name')||'',
            fein: data.get('fein')||'',
            address1: data.get('address1')||'',
            city: data.get('city')||'',
            state: data.get('state')||'',
            zip: data.get('zip')||'',
            effective_date: data.get('effective_date')||''
          },
          services: {
            cobra: data.get('svc_cobra') === 'on',
            fsa: data.get('svc_fsa') === 'on',
            hra: data.get('svc_hra') === 'on',
            hsa: data.get('svc_hsa') === 'on',
            commuter: data.get('svc_commuter') === 'on',
            other: data.get('svc_other') === 'on' ? (data.get('svc_other_text')||'') : ''
          },
          contacts: {
            primary: {
              name: data.get('contact_primary_name')||'',
              email: data.get('contact_primary_email')||'',
              phone: data.get('contact_primary_phone')||''
            },
            billing: {
              name: data.get('contact_billing_name')||'',
              email: data.get('contact_billing_email')||'',
              phone: data.get('contact_billing_phone')||''
            },
            broker: {
              name: data.get('contact_broker_name')||'',
              email: data.get('contact_broker_email')||'',
              phone: data.get('contact_broker_phone')||''
            },
            communication_preference: data.get('comm_pref')||'email'
          },
          plans: {
            medical: data.get('plan_medical') === 'on' ? {
              carrier: data.get('medical_carrier')||'',
              group: data.get('medical_group')||'',
              deductible: data.get('medical_deductible')||'',
              premium: data.get('medical_premium')||'',
              tier: data.get('medical_tier')||'',
              tier_other: data.get('medical_tier_other')||''
            } : null,
            dental: data.get('plan_dental') === 'on' ? {
              carrier: data.get('dental_carrier')||'',
              group: data.get('dental_group')||'',
              deductible: data.get('dental_deductible')||'',
              premium: data.get('dental_premium')||'',
              tier: data.get('dental_tier')||'',
              tier_other: data.get('dental_tier_other')||''
            } : null,
            vision: data.get('plan_vision') === 'on' ? {
              carrier: data.get('vision_carrier')||'',
              group: data.get('vision_group')||'',
              deductible: data.get('vision_deductible')||'',
              premium: data.get('vision_premium')||'',
              tier: data.get('vision_tier')||'',
              tier_other: data.get('vision_tier_other')||''
            } : null,
            fsa: data.get('plan_fsa') === 'on' ? {
              annual_max: data.get('fsa_annual_max')||'',
              employer_contribution: data.get('fsa_employer_contrib')||'',
              grace: data.get('fsa_grace')||''
            } : null
          },
          population: {
            total_employees: Number(data.get('total_employees')||0),
            active_cobra: Number(data.get('active_cobra')||0),
            pending_elections: Number(data.get('pending_elections')||0)
          },
          billing: {
            frequency: data.get('billing_frequency')||'',
            delivery: data.get('billing_delivery')||'',
            remit_address: data.get('remit_address')||'',
            ach: {
              bank_name: data.get('bank_name')||'',
              routing_number: data.get('routing_number')||'',
              account_last4: data.get('account_number_last4')||''
            }
          },
          authorization: {
            auth_full_name: data.get('auth_full_name')||'',
            auth_title: data.get('auth_title')||'',
            auth_date: data.get('auth_date')||'',
            signature: sigPad && !sigPad.isEmpty() ? sigPad.toDataURL('image/png') : ''
          },
          documents: {
            roster_attached: !!document.getElementById('file_roster').files.length,
            rates_attached: !!document.getElementById('file_rates').files.length,
            plan_docs_count: document.getElementById('file_plan_docs').files.length,
            additional_count: document.getElementById('file_additional').files.length
          },
          branding: { 
            primary: '#1E4E6B', 
            secondary: '#A4C639',
            tagline: 'EMPLOYEE FOCUSED ASSISTANCE'
          },
          userAgent: navigator.userAgent
        };
        return payload;
      }

      function collectMultipartForm(payload) {
        const fd = new FormData();
        fd.append('payload', new Blob([JSON.stringify(payload)], { type: 'application/json' }));
        const roster = document.getElementById('file_roster').files[0];
        const rates = document.getElementById('file_rates').files[0];
        const plans = document.getElementById('file_plan_docs').files;
        const additional = document.getElementById('file_additional').files;
        if (roster) fd.append('roster', roster);
        if (rates) fd.append('rates', rates);
        if (plans && plans.length) Array.from(plans).forEach((f,i) => fd.append('plan_doc_'+i, f));
        if (additional && additional.length) Array.from(additional).forEach((f,i) => fd.append('additional_'+i, f));
        return fd;
      }

      async function submitToWebhook() {
        const webhookUrl = 'https://services.leadconnectorhq.com/hooks/dmDqFsUr8qcR0BbIu70O/webhook-trigger/4a844145-efad-4c01-b6bb-c92721ab5f67';
        const payload = await toJSONPayload();
        const multipart = collectMultipartForm(payload);
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 30000);
          const res = await fetch(webhookUrl, { method: 'POST', body: multipart, signal: controller.signal });
          clearTimeout(timeout);
          if (!res.ok) throw new Error('HTTP '+res.status);
          return true;
        } catch (err) {
          try {
            // Fallback: post JSON payload to a hidden iframe
            const iframeName = 'hidden_iframe_' + Date.now();
            const iframe = document.createElement('iframe');
            iframe.name = iframeName; iframe.style.display = 'none'; document.body.appendChild(iframe);
            const form = document.createElement('form');
            form.method = 'POST'; form.action = webhookUrl; form.enctype = 'application/x-www-form-urlencoded'; form.target = iframeName; form.style.display = 'none';
            const input = document.createElement('input'); input.type = 'hidden'; input.name = 'payload'; input.value = JSON.stringify(payload); form.appendChild(input);
            document.body.appendChild(form); form.submit();
            setTimeout(() => { try { document.body.removeChild(form); } catch {}; try { document.body.removeChild(iframe); } catch {}; }, 3000);
            return true;
          } catch (fallbackErr) { console.error('Fallback submission failed:', fallbackErr); return false; }
        }
      }

      function summarize(payload) {
        const el = document.getElementById('submissionSummary');
        el.innerHTML = `
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
            <div><strong>Employer:</strong> ${payload.company.employer_name || 'N/A'}</div>
            <div><strong>Effective:</strong> ${payload.company.effective_date || 'N/A'}</div>
            <div><strong>Primary Contact:</strong> ${payload.contacts.primary.name || 'N/A'}</div>
            <div><strong>Email:</strong> ${payload.contacts.primary.email || 'N/A'}</div>
            <div><strong>Active COBRA:</strong> ${payload.population.active_cobra || 0}</div>
            <div><strong>Billing:</strong> ${payload.billing.frequency || 'N/A'} via ${payload.billing.delivery || 'N/A'}</div>
          </div>
        `;
      }

      prevBtn.addEventListener('click', () => {
        if (currentStep > 1) { 
          currentStep -= 1; 
          showStep(currentStep); 
          announceToScreenReader(`Moved back to step ${currentStep}`);
        }
      });

      nextBtn.addEventListener('click', async () => {
        if (!validateStep(currentStep)) { 
          announceError('Please complete required fields before continuing.');
          alert('Please complete required fields before continuing.'); 
          return; 
        }
        if (currentStep === totalSteps - 1) {
          nextBtn.disabled = true; 
          nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
          announceToScreenReader('Submitting form, please wait...');
          const ok = await submitToWebhook();
          const data = await toJSONPayload(); summarize(data);
          currentStep = totalSteps; showStep(currentStep);
          nextBtn.disabled = false; 
          nextBtn.innerHTML = 'Next<i class="fas fa-arrow-right ml-2"></i>';
          announceToScreenReader('Form submitted successfully!');
          return;
        }
        currentStep += 1; 
        showStep(currentStep);
      });

      document.getElementById('downloadJsonBtn')?.addEventListener('click', async () => {
        const data = await toJSONPayload();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `new-client-onboarding-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      document.getElementById('startOverBtn')?.addEventListener('click', () => {
        if (!confirm('Start a new submission? This will clear the current data.')) return;
        form.reset(); if (sigPad) sigPad.clear(); currentStep = 1; showStep(currentStep);
      });

      // Defaults
      const today = new Date().toISOString().split('T')[0];
      const authDate = form.querySelector('input[name="auth_date"]'); if (authDate) authDate.value = today;
      document.getElementById('printDate').textContent = new Date().toLocaleString();

      showStep(currentStep);
    })();
  </script>
</body>
</html>
