<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NueSynergy COBRA Qualified Benefits Continuation Takeover</title>
  
  <!-- Performance: Preload critical resources -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style">
  <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
  
  <!-- CSS Frameworks & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Animation Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  
  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  
  <!-- Mermaid & Tooltips -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <style>
    :root {
      --ns-blue: #1E4E6B;
      --ns-green: #A4C639;
      --ns-bg: #F0F4F0;
    }
    html, body { height: 100%; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--ns-bg); color: #1f2937; }
    .card { background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
    .step-active { display: block; }
    .step-hidden { display: none; }
    .sig-pad { border: 2px solid #e5e7eb; border-radius: 8px; background: white; }
    .progress { height: 8px; background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%); border-radius: 999px; overflow: hidden; }
    .progress > div { height: 100%; background: linear-gradient(135deg, var(--ns-green) 0%, #8fb332 100%); transition: width .4s ease; }
    /* Shared form styling (from form-styling.md) */
    .step-card { background: #fff; border-radius: 16px; border: 1px solid rgba(30,78,107,0.1); box-shadow: 0 8px 32px rgba(30,78,107,0.1); }
    .step-card:hover { box-shadow: 0 16px 48px rgba(30,78,107,0.15); transform: translateY(-2px); transition: box-shadow .2s ease, transform .2s ease; }
    .contact-section { background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB; padding: 1rem; }
    .nue-primary-text { color: var(--ns-blue); }
    .progress-bar { height: 8px; background: linear-gradient(135deg, var(--ns-green) 0%, var(--ns-blue) 100%); border-radius: 999px; overflow: hidden; }
    .progress-bar > div { height: 100%; background: linear-gradient(135deg, var(--ns-green) 0%, #8fb332 100%); transition: width .4s ease; }
    .btn-primary { background: linear-gradient(135deg, var(--ns-blue), var(--ns-green)); color: #fff; padding: 0.875rem 2rem; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 6px 16px rgba(30,78,107,0.2); }
    .btn-primary:hover { filter: brightness(1.05); }
    .btn-secondary { background: transparent; color: var(--ns-blue); border: 2px solid var(--ns-blue); padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; }
    .btn-secondary:hover { background: var(--ns-blue); color: #fff; }
    .step-indicator { width: 2rem; height: 2rem; display: inline-flex; align-items: center; justify-content: center; border-radius: 999px; background: #E5E7EB; color: #6B7280; font-weight: 600; }
    .step-indicator.active { background: var(--ns-green); color: #0B3D2E; box-shadow: 0 0 0 4px rgba(164,198,57,0.2); }
    .fade-in { animation: fadeIn .25s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }
    
    /* Enhanced animations */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--ns-green);
      color: white;
      font-size: 12px;
      font-weight: bold;
      cursor: help;
      margin-left: 6px;
      transition: transform 0.2s ease;
    }
    
    .tooltip-icon:hover {
      transform: scale(1.15);
    }
    
    .process-diagram {
      margin: 2rem 0;
      padding: 2rem;
      background: linear-gradient(135deg, rgba(30,78,107,0.03) 0%, rgba(164,198,57,0.03) 100%);
      border-radius: 16px;
      border: 2px solid rgba(30,78,107,0.1);
    }
    
    .process-diagram .mermaid {
      padding: 2rem;
      min-height: 400px;
    }
    
    .process-diagram .mermaid svg {
      max-width: 100%;
      height: auto;
    }
    
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--ns-blue), var(--ns-green));
      color: white;
      font-size: 1.25rem;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(30,78,107,0.25);
      margin-bottom: 1rem;
    }
    
    .field-group {
      opacity: 0;
      transform: translateY(20px);
    }
    
    .success-icon {
      width: 120px;
      height: 120px;
      margin: 0 auto;
      position: relative;
    }
    
    .success-circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 4;
      stroke: var(--ns-green);
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    
    .success-check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.6s forwards;
    }
    
    @keyframes stroke {
      100% {
        stroke-dashoffset: 0;
      }
    }
    
    @keyframes scale {
      0%, 100% {
        transform: none;
      }
      50% {
        transform: scale3d(1.1, 1.1, 1);
      }
    }
    
    .btn-primary, .btn-secondary {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .btn-primary::before, .btn-secondary::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn-primary:hover::before, .btn-secondary:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .mermaid {
      display: flex;
      justify-content: center;
    }
    
    @media (prefers-reduced-motion: reduce) {
      .step-card:hover { transform: none; box-shadow: 0 8px 32px rgba(30,78,107,0.1); }
      .fade-in { animation: none; }
      .field-group { opacity: 1; transform: none; }
      .success-circle, .success-check { animation: none; stroke-dashoffset: 0; }
      .btn-primary::before, .btn-secondary::before { display: none; }
    }
    
    /* Custom Tippy theme */
    .tippy-box[data-theme~='nuesynergy'] {
      background: linear-gradient(135deg, var(--ns-blue), #2a5f7a);
      color: white;
      font-size: 0.95rem;
      box-shadow: 0 8px 24px rgba(30,78,107,0.3);
      border-radius: 8px;
    }
    
    .tippy-box[data-theme~='nuesynergy'][data-placement^='top'] > .tippy-arrow::before {
      border-top-color: var(--ns-blue);
    }
    
    .tippy-box[data-theme~='nuesynergy'][data-placement^='bottom'] > .tippy-arrow::before {
      border-bottom-color: var(--ns-blue);
    }
    
    .tippy-box[data-theme~='nuesynergy'][data-placement^='left'] > .tippy-arrow::before {
      border-left-color: var(--ns-blue);
    }
    
    .tippy-box[data-theme~='nuesynergy'][data-placement^='right'] > .tippy-arrow::before {
      border-right-color: var(--ns-blue);
    }
    
    /* Enhanced checkbox and file input styles */
    input[type="checkbox"] {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    input[type="checkbox"]:hover {
      transform: scale(1.1);
    }
    
    input[type="file"] {
      cursor: pointer;
    }
    
    .contact-section {
      transition: all 0.3s ease;
    }
    
    .contact-section:has(input[type="checkbox"]:checked) {
      background: linear-gradient(135deg, rgba(30,78,107,0.05) 0%, rgba(164,198,57,0.05) 100%);
      border-color: var(--ns-green);
      box-shadow: 0 4px 12px rgba(164,198,57,0.15);
    }
    
    /* Keyboard shortcut styling */
    kbd {
      display: inline-block;
      padding: 2px 6px;
      background: #374151;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85em;
    }
    
    /* Confetti animation */
    @keyframes confetti-fall {
      0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--ns-green);
      top: -10px;
      z-index: 9999;
      animation: confetti-fall 3s linear forwards;
    }
    
    /* Header scroll effect */
    header.scrolled {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s ease;
    }
    
    /* Error States */
    .form-input.error,
    input.error,
    select.error,
    textarea.error {
      border-color: #EF4444 !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }
    
    .error-message {
      color: #EF4444;
      font-size: 14px;
      margin-top: 4px;
    }
    
    /* Pulse Animation */
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    
    /* Success Checkmark Animation */
    .success-checkmark {
      width: 80px;
      height: 80px;
      margin: 0 auto;
    }
    
    .success-checkmark .check-icon {
      width: 80px;
      height: 80px;
      position: relative;
      border-radius: 50%;
      box-sizing: content-box;
      border: 4px solid #A4C639;
    }
    
    .success-checkmark .icon-line {
      height: 5px;
      background-color: #A4C639;
      display: block;
      border-radius: 2px;
      position: absolute;
      z-index: 10;
    }
    
    .success-checkmark .icon-line.line-tip {
      top: 46px;
      left: 14px;
      width: 25px;
      transform: rotate(45deg);
      animation: icon-line-tip 0.75s;
    }
    
    .success-checkmark .icon-line.line-long {
      top: 38px;
      right: 8px;
      width: 47px;
      transform: rotate(-45deg);
      animation: icon-line-long 0.75s;
    }
    
    @keyframes icon-line-tip {
      0% { width: 0; left: 1px; top: 19px; }
      54% { width: 0; left: 1px; top: 19px; }
      70% { width: 50px; left: -8px; top: 37px; }
      84% { width: 17px; left: 21px; top: 48px; }
      100% { width: 25px; left: 14px; top: 45px; }
    }
    
    @keyframes icon-line-long {
      0% { width: 0; right: 46px; top: 54px; }
      65% { width: 0; right: 46px; top: 54px; }
      84% { width: 55px; right: 0px; top: 35px; }
      100% { width: 47px; right: 8px; top: 38px; }
    }
    
    /* Screen Reader Only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    
    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--ns-blue);
      color: white;
      padding: 8px;
      text-decoration: none;
      z-index: 100;
    }
    
    .skip-link:focus {
      top: 0;
    }
    
    /* Input base styles */
    .form-input { border: 2px solid #E5E7EB; border-radius: 8px; padding: 12px 16px; }
    .form-input:focus { outline: 3px solid rgba(164,198,57,0.4); outline-offset: 2px; border-color: #A4C639; }
    /* Apply base input styles to all inputs within the form for consistency */
    #cobraForm input:not([type="radio"]):not([type="checkbox"]):not([type="file"]):not([type="hidden"]),
    #cobraForm select,
    #cobraForm textarea { border: 2px solid #E5E7EB; border-radius: 8px; padding: 12px 16px; }
    #cobraForm input:focus, #cobraForm select:focus, #cobraForm textarea:focus { outline: 3px solid rgba(164,198,57,0.4); outline-offset: 2px; border-color: #A4C639; }
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      .card { box-shadow: none; border: 1px solid #ddd; border-radius: 0; }
      .sig-pad { border: 1px solid #ccc; }
      body { background: #fff; color: #000; }
    }
    
    /* Journey Step Cards - from FSA form */
    .process-visualization {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(30, 78, 107, 0.1);
    }
    
    .journey-step {
      position: relative;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.5rem 1rem;
      transition: all 0.3s ease;
      cursor: default;
      overflow: hidden;
    }
    
    .journey-step::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, transparent, var(--ns-green), transparent);
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }
    
    .journey-step:hover::before {
      transform: translateX(100%);
    }
    
    .journey-step-inner {
      position: relative;
      text-align: center;
    }
    
    .journey-icon-wrapper {
      position: relative;
      width: 60px;
      height: 60px;
      margin: 0 auto 1rem;
      background: linear-gradient(135deg, #f0f4f0 0%, #e5e7eb 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .journey-icon {
      font-size: 1.5rem;
      color: #6b7280;
      transition: all 0.3s ease;
    }
    
    .journey-number {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .journey-checkmark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 70px;
      height: 70px;
      background: var(--ns-green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 2;
    }
    
    .journey-checkmark i {
      color: white;
      font-size: 1.75rem;
      font-weight: bold;
    }
    
    .journey-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }
    
    .journey-description {
      font-size: 0.75rem;
      color: #9ca3af;
      line-height: 1.3;
      transition: all 0.3s ease;
    }
    
    /* Active State */
    .journey-step.active {
      background: linear-gradient(135deg, #A4C639 0%, #8fb030 100%);
      border-color: #A4C639;
      box-shadow: 0 8px 24px rgba(164, 198, 57, 0.3);
      transform: translateY(-4px);
    }
    
    .journey-step.active .journey-icon-wrapper {
      background: rgba(255, 255, 255, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }
    
    .journey-step.active .journey-icon {
      color: white;
      transform: scale(1.1);
    }
    
    .journey-step.active .journey-number {
      background: linear-gradient(135deg, #1E4E6B 0%, #2a5f7f 100%);
      box-shadow: 0 4px 12px rgba(30, 78, 107, 0.4);
    }
    
    .journey-step.active .journey-title {
      color: white;
      font-weight: 700;
    }
    
    .journey-step.active .journey-description {
      color: rgba(255, 255, 255, 0.9);
    }
    
    /* Completed State */
    .journey-step.completed {
      background: linear-gradient(135deg, #1E4E6B 0%, #2a5f7f 100%);
      border-color: #1E4E6B;
      box-shadow: 0 4px 16px rgba(30, 78, 107, 0.2);
    }
    
    .journey-step.completed .journey-icon-wrapper {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .journey-step.completed .journey-icon {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .journey-step.completed .journey-checkmark {
      transform: translate(-50%, -50%) scale(1);
    }
    
    .journey-step.completed .journey-checkmark.hidden {
      display: flex !important;
    }
    
    .journey-step.completed .journey-number {
      background: linear-gradient(135deg, #A4C639 0%, #8fb030 100%);
    }
    
    .journey-step.completed .journey-title {
      color: white;
    }
    
    .journey-step.completed .journey-description {
      color: rgba(255, 255, 255, 0.8);
    }
    
    /* Pending State */
    .journey-step.pending {
      opacity: 0.7;
    }
    
    .journey-step.pending:hover {
      opacity: 0.85;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* Shimmer animation for progress bar */
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(200%); }
    }
    
    .animate-shimmer {
      animation: shimmer 2s infinite;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .journey-step {
        padding: 1rem 0.75rem;
      }
      
      .journey-icon-wrapper {
        width: 50px;
        height: 50px;
      }
      
      .journey-icon {
        font-size: 1.25rem;
      }
      
      .journey-number {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
      }
      
      .journey-title {
        font-size: 0.85rem;
      }
      
      .journey-description {
        font-size: 0.7rem;
      }
    }
    
    /* Reduced Motion Support - CRITICAL for Accessibility */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
      
      .fade-in,
      .step-card:hover,
      .btn-primary::before,
      .btn-secondary::before {
        animation: none !important;
        transition: none !important;
      }
      
      .confetti {
        display: none !important;
      }
      
      .journey-step,
      .journey-step::before,
      .journey-icon-wrapper,
      .journey-checkmark {
        transition: none !important;
        animation: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Skip Link for Accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <!-- Screen Reader Announcements -->
  <div id="status-message" class="sr-only" role="status" aria-live="polite"></div>
  <div id="error-message" class="sr-only" role="alert" aria-live="assertive"></div>
  <div class="min-h-full">
    <header class="relative overflow-hidden" style="background: linear-gradient(135deg, var(--ns-blue) 0%, #2a5f7a 100%);">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-3 text-white">
          <div class="flex flex-col gap-2">
            <h1 class="text-3xl sm:text-4xl font-bold drop-shadow">NueSynergy</h1>
            <p class="text-sm uppercase tracking-wider opacity-90">EMPLOYEE FOCUSED ASSISTANCE</p>
            <p class="text-sm opacity-75">
              <i class="fas fa-phone mr-2"></i>1-800-413-4138 
              <span class="mx-2">|</span> 
              <i class="fas fa-envelope mr-2"></i>info@nuesynergy.com
            </p>
          </div>
          <div class="text-left md:text-right">
            <p class="text-base opacity-90 mb-2">Solutions That Fit You, Not Solutions You Must Fit</p>
            <h2 class="text-xl text-[var(--ns-green)] font-semibold">COBRA Qualified Benefits Continuation Takeover</h2>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8 mt-5" id="main-content">
      <!-- Process Overview Diagram -->
      <div id="processDiagram" class="process-diagram mb-8 step-active">
        <h3 class="text-2xl font-bold text-center nue-primary-text mb-6">Your COBRA Takeover Journey</h3>
        <div class="mermaid">
%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#A4C639', 'primaryTextColor':'#fff', 'primaryBorderColor':'#1E4E6B', 'lineColor':'#1E4E6B', 'secondaryColor':'#1E4E6B', 'tertiaryColor':'#F0F4F0', 'fontSize':'16px', 'borderRadius':'12px'}}}%%
graph TB
    A[Company Details]
    B[Employee Info]
    C[Plan Elections]
    D[Documentation]
    E[Authorization]
    F[Complete!]
    
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    
    style A fill:#A4C639,stroke:#1E4E6B,stroke-width:4px,color:#fff,rx:20,ry:20
    style B fill:#1E4E6B,stroke:#A4C639,stroke-width:3px,color:#fff,rx:20,ry:20
    style C fill:#A4C639,stroke:#1E4E6B,stroke-width:3px,color:#fff,rx:20,ry:20
    style D fill:#1E4E6B,stroke:#A4C639,stroke-width:3px,color:#fff,rx:20,ry:20
    style E fill:#A4C639,stroke:#1E4E6B,stroke-width:3px,color:#fff,rx:20,ry:20
    style F fill:#1E4E6B,stroke:#A4C639,stroke-width:4px,color:#fff,rx:20,ry:20
    
    classDef default margin:20px,padding:25px
        </div>
        <p class="text-center mt-6 text-slate-600">We'll guide you through each step with helpful tips and smooth transitions</p>
        <div class="text-center mt-4">
          <button type="button" id="startFormBtn" class="btn-primary">Begin Your Journey â†’</button>
        </div>
      </div>
      
      <!-- Enhanced Journey Progress Tracker -->
      <nav role="navigation" aria-label="Form progress" class="mb-8 step-hidden" id="journeyTracker">
        <div class="process-visualization">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h3 class="text-2xl font-bold nue-primary-text flex items-center">
                <i class="fas fa-route mr-3 text-3xl"></i>Your Journey
              </h3>
              <p class="text-sm text-gray-600 mt-1 ml-12">Track your progress through the COBRA setup</p>
            </div>
            <div class="text-right">
              <span class="text-3xl font-bold text-[var(--ns-green)]" id="progressText">Step 1</span>
              <p class="text-sm text-gray-600">of 7 steps</p>
            </div>
          </div>
          
          <!-- Progress Bar with Gradient -->
          <div class="relative w-full bg-gray-200 rounded-full h-3 mb-8 overflow-hidden">
            <div class="progress-bar h-3 rounded-full transition-all duration-700 ease-out relative" id="progressBar" style="width: 16.67%; background: linear-gradient(90deg, var(--ns-green) 0%, var(--ns-blue) 100%);">
              <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-shimmer"></div>
            </div>
          </div>
          
          <!-- Interactive Step Cards -->
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4">
            <!-- Step 1 -->
            <div class="journey-step active" id="journey-step-1" data-step="1">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-building journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
                <div class="journey-number">1</div>
                <h4 class="journey-title">Company</h4>
                <p class="journey-description">Basic details & contacts</p>
              </div>
            </div>
            
            <!-- Step 2 -->
            <div class="journey-step pending" id="journey-step-2" data-step="2">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-user journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
                <div class="journey-number">2</div>
                <h4 class="journey-title">Employee Info</h4>
                <p class="journey-description">Employee details</p>
              </div>
            </div>
            
            <!-- Step 3 -->
            <div class="journey-step pending" id="journey-step-3" data-step="3">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-heart-pulse journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
                <div class="journey-number">3</div>
                <h4 class="journey-title">Plan Elections</h4>
                <p class="journey-description">Coverage details</p>
              </div>
            </div>
            
            <!-- Step 4 -->
            <div class="journey-step pending" id="journey-step-4" data-step="4">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-folder-open journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
                <div class="journey-number">4</div>
                <h4 class="journey-title">Documentation</h4>
                <p class="journey-description">Upload documents</p>
              </div>
            </div>
            
            <!-- Step 5 -->
            <div class="journey-step pending" id="journey-step-5" data-step="5">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-user-friends journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
                <div class="journey-number">5</div>
                <h4 class="journey-title">Dependents</h4>
                <p class="journey-description">Family members</p>
              </div>
            </div>
            
            <!-- Step 6 -->
            <div class="journey-step pending" id="journey-step-6" data-step="6">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-signature journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
                <div class="journey-number">6</div>
                <h4 class="journey-title">Authorization</h4>
                <p class="journey-description">Sign & submit</p>
              </div>
            </div>
            
            <!-- Step 7 -->
            <div class="journey-step pending" id="journey-step-7" data-step="7">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-check-circle journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
                <div class="journey-number">7</div>
                <h4 class="journey-title">Complete!</h4>
                <p class="journey-description">All done</p>
              </div>
            </div>
          </div>
        </div>
      </nav>
      
      <div id="mainFormCard" class="step-card p-6 sm:p-8 fade-in step-hidden">

        <form id="cobraForm" class="space-y-8">
          <!-- Step 1: Company & Takeover Details -->
          <section data-step="1" class="step step-active">
            <div class="text-center mb-5">
              <div class="step-number mx-auto">1</div>
              <h3 class="text-xl font-semibold nue-primary-text">
                Company & Takeover Details
                <span class="tooltip-icon" data-tippy-content="We need your company information to set up your COBRA administration account. This helps us identify your organization and establish primary contact.">?</span>
              </h3>
              <p class="text-slate-600 mt-2">Provide employer and prior administrator information.</p>
              <div class="mt-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
                <p class="text-sm font-semibold text-blue-900">
                  <i class="fas fa-info-circle mr-2"></i>Important: Please complete a separate form for each COBRA participant. This form captures one participant at a time.
                </p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Employer/Group Name <span class="text-red-500">*</span></label>
                <input name="employer_name" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--ns-green)]" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Employer EIN <span class="text-red-500">*</span></label>
                <input name="fein" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Primary Contact Name <span class="text-red-500">*</span></label>
                <input name="contact_name" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Primary Contact Email <span class="text-red-500">*</span></label>
                <input type="email" name="contact_email" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Primary Contact Phone <span class="text-red-500">*</span></label>
                <input type="tel" name="contact_phone" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Takeover Effective Date <span class="text-red-500">*</span></label>
                <input type="date" name="effective_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
              <div>
                <label class="block text-sm font-medium text-slate-700">Prior COBRA Administrator</label>
                <input name="prior_admin" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Prior Admin Contact Email</label>
                <input type="email" name="prior_admin_email" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Current COBRA Administrator's End Date <span class="text-red-500">*</span></label>
                <input type="date" name="current_admin_end_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">COBRA Start Date <span class="text-red-500">*</span></label>
                <input type="date" name="cobra_start_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">COBRA End Date <span class="text-red-500">*</span></label>
                <input type="date" name="cobra_end_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Original COBRA Packet Mailed Date</label>
                <input type="date" name="cobra_packet_mailed_date" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>
          </section>

          <!-- Step 2: Employee Information -->
          <section data-step="2" class="step step-hidden">
            <div class="text-center mb-5">
              <div class="step-number mx-auto">2</div>
              <h3 class="text-xl font-semibold nue-primary-text">
                Employee Information
                <span class="tooltip-icon" data-tippy-content="Enter employee details for each person continuing COBRA coverage. We only store the last 4 digits of SSN for security. You can add multiple employees.">?</span>
              </h3>
              <p class="text-slate-600 mt-2">Complete the below form for each employee. SSN will be masked to last four.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Employee Full Name <span class="text-red-500">*</span></label>
                <input name="employee_name" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Division/Department</label>
                <input name="employee_division" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">SSN (masked) <span class="text-red-500">*</span></label>
                <input id="employee_ssn" name="employee_ssn" inputmode="numeric" autocomplete="off" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="***-**-1234" />
                <input type="hidden" id="employee_ssn_last4" name="employee_ssn_last4" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Date of Birth <span class="text-red-500">*</span></label>
                <input type="date" name="employee_dob" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Email <span class="text-red-500">*</span></label>
                <input type="email" name="employee_email" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700">Address Line 1 <span class="text-red-500">*</span></label>
                <input name="employee_address1" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700">Address Line 2</label>
                <input name="employee_address2" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">City <span class="text-red-500">*</span></label>
                <input name="employee_city" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">State <span class="text-red-500">*</span></label>
                <select name="employee_state" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2">
                  <option value="">Select State</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="DC">District of Columbia</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Zip <span class="text-red-500">*</span></label>
                <input name="employee_zip" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Phone <span class="text-red-500">*</span></label>
                <input id="employee_phone" name="employee_phone" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="(913) 555-5555" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Gender <span class="text-red-500">*</span></label>
                <select name="employee_gender" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2">
                  <option value="">Select Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Date of Termination <span class="text-red-500">*</span></label>
                <input type="date" name="employee_termination_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Reason for Termination <span class="text-red-500">*</span></label>
                <input name="employee_termination_reason" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>
            
            <div class="mt-6 text-center">
              <button type="button" id="addEmployeeBtn" class="px-6 py-3 rounded-lg bg-[var(--ns-green)] text-white font-medium hover:bg-opacity-90 transition-colors">
                + Add Additional Employee
              </button>
              <div class="mt-3">
                <a href="#" class="text-sm text-[var(--ns-blue)] hover:underline">Bulk Upload Template</a>
              </div>
            </div>
          </section>

          <!-- Step 3: COBRA Plan Elections -->
          <section data-step="3" class="step step-hidden">
            <div class="text-center mb-5">
              <div class="step-number mx-auto">3</div>
              <h3 class="text-xl font-semibold nue-primary-text">
                COBRA Plan Elections
                <span class="tooltip-icon" data-tippy-content="Select which benefit plans are available for COBRA continuation. Include carrier information, group numbers, and coverage tiers for each plan type.">?</span>
              </h3>
              <p class="text-slate-600 mt-2">Select applicable plans and provide carrier details, deductible, and coverage tier.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="contact-section">
                <label class="flex items-center gap-3 text-[var(--ns-blue)] font-semibold">
                  <input type="checkbox" name="plan_medical" class="h-5 w-5 accent-[var(--ns-green)]" /> Medical
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Carrier</label>
                    <input name="medical_carrier" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Group Number</label>
                    <input name="medical_group" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Deductible</label>
                    <input name="medical_deductible" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                </div>
                <div class="mt-3">
                  <span class="block text-sm text-slate-700 mb-1">Coverage Tier</span>
                  <div class="flex flex-wrap gap-3 text-sm items-center">
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="employee_only" class="h-4 w-4 accent-[var(--ns-green)]" /> Employee Only</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="ee_spouse" class="h-4 w-4 accent-[var(--ns-green)]" /> EE + Spouse</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="ee_children" class="h-4 w-4 accent-[var(--ns-green)]" /> EE + Child(ren)</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="family" class="h-4 w-4 accent-[var(--ns-green)]" /> Family</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="medical_tier" value="other" data-tier-radio data-other-input-id="medical_tier_other" class="h-4 w-4 accent-[var(--ns-green)]" /> Other</label>
                    <input type="text" id="medical_tier_other" name="medical_tier_other" placeholder="Specify other" class="border-2 border-slate-200 rounded px-3 py-2 disabled:bg-slate-100" disabled />
                  </div>
                </div>
              </div>

              <div class="contact-section">
                <label class="flex items-center gap-3 text-[var(--ns-blue)] font-semibold">
                  <input type="checkbox" name="plan_dental" class="h-5 w-5 accent-[var(--ns-green)]" /> Dental
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Carrier</label>
                    <input name="dental_carrier" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Group Number</label>
                    <input name="dental_group" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Deductible</label>
                    <input name="dental_deductible" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                </div>
                <div class="mt-3">
                  <span class="block text-sm text-slate-700 mb-1">Coverage Tier</span>
                  <div class="flex flex-wrap gap-3 text-sm items-center">
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="employee_only" class="h-4 w-4 accent-[var(--ns-green)]" /> Employee Only</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="ee_spouse" class="h-4 w-4 accent-[var(--ns-green)]" /> EE + Spouse</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="ee_children" class="h-4 w-4 accent-[var(--ns-green)]" /> EE + Child(ren)</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="family" class="h-4 w-4 accent-[var(--ns-green)]" /> Family</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="dental_tier" value="other" data-tier-radio data-other-input-id="dental_tier_other" class="h-4 w-4 accent-[var(--ns-green)]" /> Other</label>
                    <input type="text" id="dental_tier_other" name="dental_tier_other" placeholder="Specify other" class="border-2 border-slate-200 rounded px-3 py-2 disabled:bg-slate-100" disabled />
                  </div>
                </div>
              </div>

              <div class="contact-section">
                <label class="flex items-center gap-3 text-[var(--ns-blue)] font-semibold">
                  <input type="checkbox" name="plan_vision" class="h-5 w-5 accent-[var(--ns-green)]" /> Vision
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Carrier</label>
                    <input name="vision_carrier" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Group Number</label>
                    <input name="vision_group" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Deductible</label>
                    <input name="vision_deductible" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                </div>
                <div class="mt-3">
                  <span class="block text-sm text-slate-700 mb-1">Coverage Tier</span>
                  <div class="flex flex-wrap gap-3 text-sm items-center">
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="employee_only" class="h-4 w-4 accent-[var(--ns-green)]" /> Employee Only</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="ee_spouse" class="h-4 w-4 accent-[var(--ns-green)]" /> EE + Spouse</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="ee_children" class="h-4 w-4 accent-[var(--ns-green)]" /> EE + Child(ren)</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="family" class="h-4 w-4 accent-[var(--ns-green)]" /> Family</label>
                    <label class="inline-flex items-center gap-2"><input type="radio" name="vision_tier" value="other" data-tier-radio data-other-input-id="vision_tier_other" class="h-4 w-4 accent-[var(--ns-green)]" /> Other</label>
                    <input type="text" id="vision_tier_other" name="vision_tier_other" placeholder="Specify other" class="border-2 border-slate-200 rounded px-3 py-2 disabled:bg-slate-100" disabled />
                  </div>
                </div>
              </div>

              <div class="contact-section">
                <label class="flex items-center gap-3 text-[var(--ns-blue)] font-semibold">
                  <input type="checkbox" name="plan_fsa" class="h-5 w-5 accent-[var(--ns-green)]" /> FSA
                </label>
                <p class="mt-2 text-xs italic text-slate-600">If NueSynergy is NOT the FSA administrator, please provide the following information:</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Initial Amount Elected</label>
                    <input name="fsa_initial_elected" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Amount Contributed</label>
                    <input name="fsa_amount_contributed" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700 leading-tight">Amount<br />Disbursed</label>
                    <input name="fsa_amount_disbursed" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Step 4: COBRA Population & Files -->
          <section data-step="4" class="step step-hidden">
            <div class="text-center mb-5">
              <div class="step-number mx-auto">4</div>
              <h3 class="text-xl font-semibold nue-primary-text">
                COBRA Population & Required Files
                <span class="tooltip-icon" data-tippy-content="Tell us about your current COBRA participants and upload any supporting documents like rosters, rate sheets, or carrier bills to help us process the takeover smoothly.">?</span>
              </h3>
              <p class="text-slate-600 mt-2">Provide counts and upload supporting documentation.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Active COBRA Participants <span class="text-red-500">*</span></label>
                <input type="number" min="0" step="1" name="active_participants" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Last Paid-Through Date <span class="text-red-500">*</span></label>
                <input type="date" name="last_paid_through" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>

            <div class="mt-6">
              <div class="mb-4 flex flex-wrap gap-3">
                <button type="button" id="rosterTemplateBtn" class="px-4 py-2 rounded-lg border-2 border-[var(--ns-blue)] text-[var(--ns-blue)] font-medium hover:bg-[var(--ns-blue)] hover:text-white transition-colors text-sm">
                  <i class="fas fa-download mr-2"></i>Download Roster Template (CSV)
                </button>
                <button type="button" id="rateSheetTemplateBtn" class="px-4 py-2 rounded-lg border-2 border-[var(--ns-blue)] text-[var(--ns-blue)] font-medium hover:bg-[var(--ns-blue)] hover:text-white transition-colors text-sm">
                  <i class="fas fa-download mr-2"></i>Download Rate Sheet Template (PDF)
                </button>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-slate-700">Participant Roster (CSV/XLSX/PDF)</label>
                  <input id="file_roster" type="file" accept=".csv,.xlsx,.xls,.pdf" class="mt-1 block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-medium file:bg-[var(--ns-blue)] file:text-white hover:file:opacity-90" />
                  <p class="text-xs text-slate-500 mt-1">Include current COBRA participants, dependents, coverage tier, and premium amounts.</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700">Rate Sheets / Carrier Bills (PDF)</label>
                  <input id="file_rates" type="file" accept=".pdf" class="mt-1 block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-medium file:bg-[var(--ns-blue)] file:text-white hover:file:opacity-90" />
                </div>
              </div>
            </div>
          </section>

          <!-- Step 5: Dependent Information -->
          <section data-step="5" class="step step-hidden">
            <div class="text-center mb-5">
              <div class="step-number mx-auto">5</div>
              <h3 class="text-xl font-semibold nue-primary-text">
                Dependent Information
                <span class="tooltip-icon" data-tippy-content="Add information for each dependent who is a qualified beneficiary for COBRA coverage.">?</span>
              </h3>
              <p class="text-slate-600 mt-2">Add dependents who are qualified beneficiaries.</p>
            </div>

            <div class="mt-3">
              <div class="flex items-center justify-between">
                <span class="text-sm text-slate-600">Full Name, Date of Birth, SSN, Relationship</span>
                <button type="button" id="addDepBtn" class="px-4 py-2 rounded-lg bg-[var(--ns-green)] text-white font-medium hover:bg-opacity-90 transition-colors text-sm">Add Row</button>
              </div>
              <div id="depTable" class="mt-3 space-y-2"></div>
            </div>
          </section>

          <!-- Step 6: Authorization & Submit -->
          <section data-step="6" class="step step-hidden">
            <div class="text-center mb-5">
              <div class="step-number mx-auto">6</div>
              <h3 class="text-xl font-semibold nue-primary-text">
                Authorization & Submission
                <span class="tooltip-icon" data-tippy-content="Final step! Review the information provided and authorize NueSynergy to process the COBRA takeover on your behalf. Your digital signature confirms accuracy and authorization.">?</span>
              </h3>
              <p class="text-slate-600 mt-2">Please review, sign, and submit.</p>
            </div>

            <div class="space-y-4">
              <div class="rounded-lg border-2 border-slate-200 p-4 bg-slate-50">
                <p class="text-sm text-slate-700">By signing below, I certify that I am authorized to provide COBRA takeover information on behalf of the Employer/Group listed and that the information submitted is accurate to the best of my knowledge.</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-medium text-slate-700">Authorized Signer Full Name <span class="text-red-500">*</span></label>
                  <input name="auth_full_name" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700">Title</label>
                  <input name="auth_title" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700">Date <span class="text-red-500">*</span></label>
                  <input type="date" name="auth_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Signature <span class="text-red-500">*</span></label>
                <canvas id="sigPad" class="sig-pad w-full h-48"></canvas>
                <div class="mt-2 flex gap-2">
                  <button type="button" id="sigClear" class="px-3 py-2 rounded bg-slate-600 text-white text-sm">Clear</button>
                </div>
              </div>
              <div class="flex items-start gap-3 mt-3">
                <input id="ack" type="checkbox" class="mt-1 h-4 w-4 accent-[var(--ns-green)]" required />
                <label for="ack" class="text-sm text-slate-700">I acknowledge NueSynergy will process COBRA takeover according to provided documentation and will contact the primary contact if clarification is needed.</label>
              </div>
            </div>
          </section>

          <!-- Confirmation -->
          <section data-step="7" class="step step-hidden">
            <div class="text-center">
              <svg class="success-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="success-circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="success-check" fill="none" stroke="#A4C639" stroke-width="4" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
              </svg>
              <h3 class="mt-6 text-3xl font-bold text-[var(--ns-blue)]">Submission Received! ðŸŽ‰</h3>
              <p class="mt-3 text-lg text-slate-600">Thank you. Your COBRA takeover details were submitted successfully.</p>
              <div class="mt-4 p-4 bg-gradient-to-r from-[var(--ns-blue)]/10 to-[var(--ns-green)]/10 rounded-lg border-2 border-[var(--ns-green)]/30">
                <p class="text-slate-700">A confirmation email has been sent, and our team will begin processing your request immediately.</p>
              </div>
              <div id="submissionSummary" class="mt-6 text-left mx-auto max-w-4xl p-6 bg-slate-50 rounded border border-slate-200"></div>
              <div class="mt-6 flex flex-wrap items-center justify-center gap-3">
                <button type="button" onclick="window.print()" class="btn-secondary">Print</button>
                <button type="button" id="startOverBtn" class="btn-primary">Start New</button>
              </div>
            </div>
          </section>

          <!-- Nav -->
          <div class="mt-6 pt-6 border-t border-slate-200 flex items-center justify-between no-print">
            <button type="button" id="prevBtn" class="btn-secondary">Previous</button>
            <div class="flex items-center gap-2">
              <button type="button" id="skipBtn" class="hidden btn-secondary">Skip</button>
              <button type="button" id="nextBtn" class="btn-primary">Next</button>
            </div>
          </div>
        </form>
      </div>

      <div class="print-only text-center mt-6">
        <h1 class="text-2xl font-bold nue-primary-text">NueSynergy: COBRA Qualified Benefits Continuation Takeover</h1>
        <p class="text-slate-600">Generated on <span id="printDate"></span></p>
      </div>
    </main>
  </div>

  <script>
    (function() {
      'use strict';
      
      // Initialize Mermaid
      mermaid.initialize({ 
        startOnLoad: true,
        theme: 'base',
        securityLevel: 'loose'
      });

      const form = document.getElementById('cobraForm');
      const steps = Array.from(document.querySelectorAll('section.step'));
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const skipBtn = document.getElementById('skipBtn');
      const progressFill = document.getElementById('progressFill');
      const progressLabels = Array.from(document.querySelectorAll('#progressLabels > div'));
      const processDiagram = document.getElementById('processDiagram');
      const mainFormCard = document.getElementById('mainFormCard');
      const startFormBtn = document.getElementById('startFormBtn');

      let currentStep = 1;
      const totalSteps = 7;
      let formStarted = false;
      let formData = {};
      
      // Screen Reader Announcement Functions
      function announceToScreenReader(message) {
        const statusEl = document.getElementById('status-message');
        if (statusEl) {
          statusEl.textContent = message;
          // Clear after a delay to allow for re-announcements
          setTimeout(() => {
            statusEl.textContent = '';
          }, 1000);
        }
      }
      
      function announceError(message) {
        const errorEl = document.getElementById('error-message');
        if (errorEl) {
          errorEl.textContent = message;
          setTimeout(() => {
            errorEl.textContent = '';
          }, 1000);
        }
      }
      
      // LocalStorage Auto-Save Functions
      function saveCurrentStepData() {
        if (!formStarted) return;
        
        const currentStepElement = steps[currentStep - 1];
        if (!currentStepElement) return;
        
        const inputs = currentStepElement.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          const name = input.name;
          if (name) {
            if (input.type === 'checkbox') {
              formData[name] = input.checked;
            } else if (input.type === 'radio') {
              if (input.checked) {
                formData[name] = input.value;
              }
            } else {
              formData[name] = input.value;
            }
          }
        });
      }
      
      function saveProgress() {
        try {
          saveCurrentStepData();
          
          const progressData = {
            currentStep: currentStep,
            formData: formData,
            formStarted: formStarted,
            timestamp: new Date().toISOString()
          };
          
          localStorage.setItem('cobraFormProgress', JSON.stringify(progressData));
          announceToScreenReader('Progress saved');
        } catch (error) {
          console.error('Error saving progress:', error);
        }
      }
      
      function loadSavedProgress() {
        try {
          const saved = localStorage.getItem('cobraFormProgress');
          if (saved) {
            const progress = JSON.parse(saved);
            
            if (progress.formStarted && progress.formData) {
              // Only restore if within 24 hours
              const savedTime = new Date(progress.timestamp);
              const now = new Date();
              const hoursDiff = (now - savedTime) / (1000 * 60 * 60);
              
              if (hoursDiff < 24) {
                formData = progress.formData;
                
                // Restore form values
                Object.keys(formData).forEach(name => {
                  const elements = document.querySelectorAll(`[name="${name}"]`);
                  elements.forEach(element => {
                    if (element.type === 'radio' || element.type === 'checkbox') {
                      if (element.type === 'checkbox') {
                        element.checked = formData[name] === true;
                      } else {
                        element.checked = element.value === formData[name];
                      }
                    } else {
                      element.value = formData[name] || '';
                    }
                  });
                });
                
                announceToScreenReader('Previous progress restored');
                return true;
              } else {
                // Clear old data
                localStorage.removeItem('cobraFormProgress');
              }
            }
          }
        } catch (error) {
          console.error('Error loading saved progress:', error);
          localStorage.removeItem('cobraFormProgress');
        }
        return false;
      }

      // Initialize tooltips
      function initTooltips() {
        tippy('[data-tippy-content]', {
          theme: 'nuesynergy',
          placement: 'top',
          animation: 'scale',
          duration: [300, 200],
          arrow: true,
          interactive: true,
          maxWidth: 350,
        });
      }

      // Animate form field entrance
      function animateFieldsIn(stepElement) {
        const fields = stepElement.querySelectorAll('.grid > div, .contact-section, .space-y-4 > div');
        anime({
          targets: fields,
          opacity: [0, 1],
          translateY: [30, 0],
          delay: anime.stagger(80, {start: 200}),
          duration: 600,
          easing: 'easeOutCubic'
        });
      }

      // Animate progress bar
      function animateProgress(percentage) {
        anime({
          targets: progressFill,
          width: percentage + '%',
          duration: 800,
          easing: 'easeInOutQuad'
        });
      }

      // Animate step transition
      function animateStepTransition(oldStep, newStep, direction = 'forward') {
        const oldElement = steps[oldStep - 1];
        const newElement = steps[newStep - 1];
        
        // Animate out old step
        anime({
          targets: oldElement,
          opacity: [1, 0],
          translateX: direction === 'forward' ? [-20, 0] : [20, 0],
          duration: 300,
          easing: 'easeInCubic',
          complete: () => {
            oldElement.classList.remove('step-active');
            oldElement.classList.add('step-hidden');
            
            // Animate in new step
            newElement.classList.remove('step-hidden');
            newElement.classList.add('step-active');
            
            anime({
              targets: newElement,
              opacity: [0, 1],
              translateX: direction === 'forward' ? [20, 0] : [-20, 0],
              duration: 400,
              easing: 'easeOutCubic'
            });
          }
        });
      }

      // Start form with animation
      startFormBtn?.addEventListener('click', () => {
        formStarted = true;
        
        // Try to load saved progress
        const progressRestored = loadSavedProgress();
        
        // Animate diagram out
        anime({
          targets: processDiagram,
          opacity: [1, 0],
          scale: [1, 0.95],
          duration: 400,
          easing: 'easeInCubic',
          complete: () => {
            processDiagram.classList.remove('step-active');
            processDiagram.classList.add('step-hidden');
            
            // Show journey tracker
            const journeyTracker = document.getElementById('journeyTracker');
            if (journeyTracker) {
              journeyTracker.classList.remove('step-hidden');
              anime({
                targets: journeyTracker,
                opacity: [0, 1],
                translateY: [30, 0],
                duration: 600,
                easing: 'easeOutCubic',
                delay: 200
              });
            }
            
            // Animate form card in
            mainFormCard.classList.remove('step-hidden');
            mainFormCard.classList.add('step-active');
            
            anime({
              targets: mainFormCard,
              opacity: [0, 1],
              scale: [0.95, 1],
              duration: 600,
              easing: 'easeOutCubic',
              complete: () => {
                initTooltips();
                announceToScreenReader('Form loaded. Step 1 of 6');
              }
            });
          }
        });
      });

      // Signature Pad
      const sigCanvas = document.getElementById('sigPad');
      let sigPad;
      function initSigPad() {
        if (!sigCanvas) return;
        sigPad = new SignaturePad(sigCanvas, {
          backgroundColor: 'rgba(255,255,255,1)',
          penColor: 'rgb(0,0,0)',
          minWidth: 1.0,
          maxWidth: 2.5,
        });
        const clearBtn = document.getElementById('sigClear');
        clearBtn?.addEventListener('click', () => sigPad.clear());
        function resize() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          sigCanvas.width = sigCanvas.offsetWidth * ratio;
          sigCanvas.height = sigCanvas.offsetHeight * ratio;
          sigCanvas.getContext('2d').scale(ratio, ratio);
        }
        window.addEventListener('resize', resize);
        resize();
      }

      function showStep(n, useAnimation = true) {
        if (!formStarted) {
          return; // Don't show steps until form is started
        }
        
        const oldStep = currentStep;
        
        // Save current step data before moving
        if (oldStep !== n) {
          saveCurrentStepData();
          saveProgress();
        }
        
        currentStep = n;
        
        if (useAnimation && oldStep !== n) {
          const direction = n > oldStep ? 'forward' : 'backward';
          animateStepTransition(oldStep, n, direction);
        } else {
          steps.forEach((s,i) => {
            s.classList.toggle('step-active', i+1 === n);
            s.classList.toggle('step-hidden', i+1 !== n);
          });
          if (useAnimation) {
            animateFieldsIn(steps[n-1]);
          }
        }
        
        // Animate button visibility
        if (n === 1) {
          anime({
            targets: prevBtn,
            opacity: [1, 0],
            duration: 200,
            complete: () => { prevBtn.style.visibility = 'hidden'; }
          });
        } else if (oldStep === 1) {
          prevBtn.style.visibility = 'visible';
          anime({
            targets: prevBtn,
            opacity: [0, 1],
            duration: 200
          });
        }
        
        if (n < totalSteps) {
          nextBtn.textContent = n === totalSteps - 1 ? 'âœ“ Submit' : 'Next â†’';
        }
        
        if (n === totalSteps) {
          nextBtn.classList.add('hidden');
          // Celebrate with confetti!
          createConfetti();
          anime({
            targets: '.success-icon',
            scale: [0.5, 1],
            rotate: [0, 360],
            duration: 1000,
            easing: 'easeOutElastic(1, .8)'
          });
        } else {
          nextBtn.classList.remove('hidden');
        }
        
        // Animate progress bar
        const percentage = ((n-1)/(totalSteps-1))*100;
        animateProgress(percentage);
        
        // Update progress text
        const progressText = document.getElementById('progressText');
        if (progressText) {
          progressText.textContent = `Step ${n}`;
        }
        
        // Update progress bar with FSA-style
        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
          anime({
            targets: progressBar,
            width: `${(n / totalSteps) * 100}%`,
            duration: 700,
            easing: 'easeInOutQuad'
          });
        }
        
        // Update journey step cards
        for (let i = 1; i <= totalSteps; i++) {
          const journeyStep = document.getElementById(`journey-step-${i}`);
          if (journeyStep) {
            journeyStep.className = 'journey-step';
            
            if (i < n) {
              journeyStep.classList.add('completed');
              // Show checkmark for completed steps
              const checkmark = journeyStep.querySelector('.journey-checkmark');
              if (checkmark) {
                checkmark.classList.remove('hidden');
              }
            } else if (i === n) {
              journeyStep.classList.add('active');
              // Pulse animation for active step
              anime({
                targets: journeyStep,
                scale: [1, 1.05, 1],
                duration: 600,
                easing: 'easeInOutQuad'
              });
            } else {
              journeyStep.classList.add('pending');
            }
          }
        }
        
        // Update progress labels with animation (if they exist)
        if (progressLabels && progressLabels.length > 0) {
          progressLabels.forEach((el, idx) => {
            const shouldBeBold = idx < n;
            if (el.classList.contains('font-semibold') !== shouldBeBold) {
              anime({
                targets: el,
                scale: shouldBeBold ? [1, 1.1, 1] : [1, 0.95, 1],
                duration: 300,
                complete: () => {
                  el.classList.toggle('font-semibold', shouldBeBold);
                  el.classList.toggle('nue-primary-text', shouldBeBold);
                }
              });
            }
          });
        }
        
        // Initialize signature pad on step 6
        if (n === 6 && !sigPad) {
          setTimeout(() => {
            initSigPad();
            // Animate signature pad in
            anime({
              targets: '#sigPad',
              opacity: [0, 1],
              scale: [0.95, 1],
              duration: 600,
              easing: 'easeOutCubic'
            });
          }, 400);
        }
        
        if (n === 7) {
          document.getElementById('printDate').textContent = new Date().toLocaleString();
        }
        
        // Announce step change to screen readers
        if (oldStep !== n) {
          announceToScreenReader(`Step ${n} of ${totalSteps}`);
        }
        
        // Scroll to top smoothly
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Enable/disable "Other" text inputs tied to tier radios
      document.addEventListener('change', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLInputElement)) return;
        
        // Handle plan checkbox animations
        if (target.type === 'checkbox' && target.name.startsWith('plan_')) {
          const section = target.closest('.contact-section');
          if (section) {
            anime({
              targets: section,
              scale: target.checked ? [1, 1.02, 1] : [1, 0.98, 1],
              duration: 300,
              easing: 'easeOutCubic'
            });
            
            // Show/hide related fields with animation
            const relatedInputs = section.querySelectorAll('input:not([type="checkbox"]), select');
            if (target.checked) {
              anime({
                targets: relatedInputs,
                opacity: [0.5, 1],
                duration: 400,
                easing: 'easeOutCubic'
              });
            }
          }
        }
        
        if (target.matches('[data-tier-radio]')) {
          const groupName = target.name;
          const otherInputId = target.getAttribute('data-other-input-id');
          const otherInput = otherInputId ? document.getElementById(otherInputId) : null;
          const selected = document.querySelector(`input[name="${groupName}"]:checked`);
          const isOther = selected && selected.value === 'other';
          if (otherInput) {
            otherInput.disabled = !isOther;
            if (!isOther) otherInput.value = '';
            
            // Animate the "other" input
            if (isOther) {
              anime({
                targets: otherInput,
                opacity: [0, 1],
                translateX: [-20, 0],
                duration: 300,
                easing: 'easeOutCubic'
              });
            }
          }
        }
      });
      
      // Add file upload feedback
      document.querySelectorAll('input[type="file"]').forEach(fileInput => {
        fileInput.addEventListener('change', function(e) {
          const fileName = this.files[0]?.name;
          if (fileName) {
            // Create or update feedback element
            let feedback = this.nextElementSibling?.classList.contains('file-feedback') 
              ? this.nextElementSibling 
              : null;
            
            if (!feedback) {
              feedback = document.createElement('div');
              feedback.className = 'file-feedback mt-2 text-sm text-[var(--ns-green)] flex items-center gap-2';
              this.parentNode.insertBefore(feedback, this.nextSibling);
            }
            
            feedback.innerHTML = `âœ“ ${fileName}`;
            
            // Animate feedback
            anime({
              targets: feedback,
              opacity: [0, 1],
              translateY: [-10, 0],
              duration: 400,
              easing: 'easeOutCubic'
            });
          }
        });
      });

      function validateStep(n) {
        const stepEl = steps[n-1];
        if (!stepEl) return true;
        const required = Array.from(stepEl.querySelectorAll('[required]'));
        let ok = true;
        const errors = [];
        
        // Clear previous errors
        stepEl.querySelectorAll('.error').forEach(field => {
          field.classList.remove('error');
          field.classList.remove('ring-2');
          field.classList.remove('ring-red-500');
        });
        
        required.forEach(inp => {
          // Skip hidden fields and their parents
          const parentDiv = inp.closest('div[id$="Field"]') || inp.closest('div[id*="Details"]') || inp.closest('.contact-section');
          if (parentDiv && parentDiv.style.display === 'none') {
            return; // Skip hidden conditional fields
          }
          
          // Also check if field itself is hidden
          const visible = inp.offsetParent !== null;
          if (!visible || inp.style.display === 'none') {
            return;
          }
          
          // Validate based on field type
          let empty = false;
          if (inp.type === 'radio') {
            const radioGroup = stepEl.querySelectorAll(`input[name="${inp.name}"]`);
            const isChecked = Array.from(radioGroup).some(radio => radio.checked);
            empty = !isChecked;
            if (empty && radioGroup.length > 0) {
              radioGroup[0].classList.add('error');
            }
          } else if (inp.type === 'checkbox' && inp.hasAttribute('required')) {
            empty = !inp.checked;
          } else {
            empty = !String(inp.value||'').trim();
          }
          
          if (empty) {
            inp.classList.add('error');
            inp.classList.add('ring-2');
            inp.classList.add('ring-red-500');
            ok = false;
            
            const label = inp.closest('div')?.querySelector('label');
            if (label) {
              errors.push(label.textContent.replace('*', '').trim());
            }
          }
        });
        
        if (n === 3) {
          // Conditional validation for plan selections
          const medicalChecked = stepEl.querySelector('input[name="plan_medical"]')?.checked;
          const dentalChecked = stepEl.querySelector('input[name="plan_dental"]')?.checked;
          const visionChecked = stepEl.querySelector('input[name="plan_vision"]')?.checked;
          const fsaChecked = stepEl.querySelector('input[name="plan_fsa"]')?.checked;
          
          if (medicalChecked) {
            const carrier = stepEl.querySelector('input[name="medical_carrier"]');
            const group = stepEl.querySelector('input[name="medical_group"]');
            const deductible = stepEl.querySelector('input[name="medical_deductible"]');
            const tierSelected = stepEl.querySelector('input[name="medical_tier"]:checked');
            
            [carrier, group, deductible].forEach(field => {
              if (field && !field.value.trim()) {
                field.classList.add('error', 'ring-2', 'ring-red-500');
                ok = false;
                errors.push('Medical plan details');
              }
            });
            
            if (!tierSelected) {
              const firstTierRadio = stepEl.querySelector('input[name="medical_tier"]');
              if (firstTierRadio) {
                firstTierRadio.classList.add('error');
                ok = false;
                errors.push('Medical coverage tier');
              }
            } else if (tierSelected.value === 'other') {
              const otherInput = stepEl.querySelector('input[name="medical_tier_other"]');
              if (otherInput && !otherInput.value.trim()) {
                otherInput.classList.add('error', 'ring-2', 'ring-red-500');
                ok = false;
                errors.push('Medical tier specification');
              }
            }
          }
          
          if (dentalChecked) {
            const carrier = stepEl.querySelector('input[name="dental_carrier"]');
            const group = stepEl.querySelector('input[name="dental_group"]');
            const deductible = stepEl.querySelector('input[name="dental_deductible"]');
            const tierSelected = stepEl.querySelector('input[name="dental_tier"]:checked');
            
            [carrier, group, deductible].forEach(field => {
              if (field && !field.value.trim()) {
                field.classList.add('error', 'ring-2', 'ring-red-500');
                ok = false;
                errors.push('Dental plan details');
              }
            });
            
            if (!tierSelected) {
              const firstTierRadio = stepEl.querySelector('input[name="dental_tier"]');
              if (firstTierRadio) {
                firstTierRadio.classList.add('error');
                ok = false;
                errors.push('Dental coverage tier');
              }
            } else if (tierSelected.value === 'other') {
              const otherInput = stepEl.querySelector('input[name="dental_tier_other"]');
              if (otherInput && !otherInput.value.trim()) {
                otherInput.classList.add('error', 'ring-2', 'ring-red-500');
                ok = false;
                errors.push('Dental tier specification');
              }
            }
          }
          
          if (visionChecked) {
            const carrier = stepEl.querySelector('input[name="vision_carrier"]');
            const group = stepEl.querySelector('input[name="vision_group"]');
            const deductible = stepEl.querySelector('input[name="vision_deductible"]');
            const tierSelected = stepEl.querySelector('input[name="vision_tier"]:checked');
            
            [carrier, group, deductible].forEach(field => {
              if (field && !field.value.trim()) {
                field.classList.add('error', 'ring-2', 'ring-red-500');
                ok = false;
                errors.push('Vision plan details');
              }
            });
            
            if (!tierSelected) {
              const firstTierRadio = stepEl.querySelector('input[name="vision_tier"]');
              if (firstTierRadio) {
                firstTierRadio.classList.add('error');
                ok = false;
                errors.push('Vision coverage tier');
              }
            } else if (tierSelected.value === 'other') {
              const otherInput = stepEl.querySelector('input[name="vision_tier_other"]');
              if (otherInput && !otherInput.value.trim()) {
                otherInput.classList.add('error', 'ring-2', 'ring-red-500');
                ok = false;
                errors.push('Vision tier specification');
              }
            }
          }
          
          if (fsaChecked) {
            const initialElected = stepEl.querySelector('input[name="fsa_initial_elected"]');
            const amountContributed = stepEl.querySelector('input[name="fsa_amount_contributed"]');
            const amountDisbursed = stepEl.querySelector('input[name="fsa_amount_disbursed"]');
            
            [initialElected, amountContributed, amountDisbursed].forEach(field => {
              if (field && !field.value.trim()) {
                field.classList.add('error', 'ring-2', 'ring-red-500');
                ok = false;
                errors.push('FSA details');
              }
            });
          }
        }
        
        if (n === 4) {
          // File uploads are now optional, no validation needed
        }
        
        if (n === 6) {
          const ack = document.getElementById('ack');
          if (ack && !ack.checked) {
            ack.classList.add('error');
            ok = false;
            errors.push('Acknowledgment');
          }
          if (sigPad && sigPad.isEmpty()) {
            ok = false;
            errors.push('Signature');
          }
        }
        
        // Announce validation results
        if (!ok && errors.length > 0) {
          announceError(`Please complete: ${errors.slice(0, 3).join(', ')}`);
        }
        
        return ok;
      }

      async function toJSONPayload() {
        const data = new FormData(form);
        const payload = {
          formType: 'cobra_takeover',
          submissionTimestamp: new Date().toISOString(),
          company: {
            employer_name: data.get('employer_name')||'',
            fein: data.get('fein')||'',
            contact_name: data.get('contact_name')||'',
            contact_email: data.get('contact_email')||'',
            contact_phone: data.get('contact_phone')||'',
            effective_date: data.get('effective_date')||''
          },
          priorAdministrator: {
            name: data.get('prior_admin')||'',
            email: data.get('prior_admin_email')||''
          },
          employee: {
            name: data.get('employee_name')||'',
            ssn_last4: data.get('employee_ssn_last4')||'',
            dob: data.get('employee_dob')||'',
            email: data.get('employee_email')||'',
            address1: data.get('employee_address1')||'',
            address2: data.get('employee_address2')||'',
            city: data.get('employee_city')||'',
            state: data.get('employee_state')||'',
            zip: data.get('employee_zip')||'',
            phone: data.get('employee_phone')||''
          },
          plans: {
            medical: data.get('plan_medical') === 'on' ? {
              carrier: data.get('medical_carrier')||'',
              group: data.get('medical_group')||'',
              deductible: data.get('medical_deductible')||'',
              tier: data.get('medical_tier')||'',
              tier_other: data.get('medical_tier_other')||''
            } : null,
            dental: data.get('plan_dental') === 'on' ? {
              carrier: data.get('dental_carrier')||'',
              group: data.get('dental_group')||'',
              deductible: data.get('dental_deductible')||'',
              tier: data.get('dental_tier')||'',
              tier_other: data.get('dental_tier_other')||''
            } : null,
            vision: data.get('plan_vision') === 'on' ? {
              carrier: data.get('vision_carrier')||'',
              group: data.get('vision_group')||'',
              deductible: data.get('vision_deductible')||'',
              tier: data.get('vision_tier')||'',
              tier_other: data.get('vision_tier_other')||''
            } : null,
            fsa: data.get('plan_fsa') === 'on' ? {
              initial_amount_elected: data.get('fsa_initial_elected')||'',
              amount_contributed: data.get('fsa_amount_contributed')||'',
              amount_disbursed: data.get('fsa_amount_disbursed')||''
            } : null
          },
          population: {
            active_participants: Number(data.get('active_participants')||0),
            pending_elections: Number(data.get('pending_elections')||0),
            last_paid_through: data.get('last_paid_through')||''
          },
          authorization: {
            auth_full_name: data.get('auth_full_name')||'',
            auth_title: data.get('auth_title')||'',
            auth_date: data.get('auth_date')||'',
            signature: sigPad && !sigPad.isEmpty() ? sigPad.toDataURL('image/png') : ''
          },
          documents: {
            roster_attached: !!document.getElementById('file_roster')?.files?.length,
            rates_attached: !!document.getElementById('file_rates')?.files?.length,
            takeover_letter_attached: false,
            additional_count: 0
          },
          branding: { primary: '#1E4E6B', secondary: '#A4C639', bg: '#F0F4F0' },
          userAgent: navigator.userAgent
        };
        return payload;
      }

      function collectMultipartForm(payload) {
        const fd = new FormData();
        fd.append('payload', new Blob([JSON.stringify(payload)], { type: 'application/json' }));
        const roster = document.getElementById('file_roster')?.files?.[0];
        const rates = document.getElementById('file_rates')?.files?.[0];
        if (roster) fd.append('roster', roster);
        if (rates) fd.append('rates', rates);
        return fd;
      }

      async function submitToWebhook() {
        const webhookUrl = 'https://services.leadconnectorhq.com/hooks/dmDqFsUr8qcR0BbIu70O/webhook-trigger/ee199673-bc95-4606-94c3-1be4db0630d7';
        const payload = await toJSONPayload();
        const multipart = collectMultipartForm(payload);

        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 30000);
          const res = await fetch(webhookUrl, { method: 'PUT', body: multipart, signal: controller.signal });
          clearTimeout(timeout);
          if (!res.ok) throw new Error('HTTP '+res.status);
          return true;
        } catch (err) {
          try {
            // Fallback: post JSON payload to a hidden iframe to avoid navigating away
            const iframeName = 'hidden_iframe_' + Date.now();
            const iframe = document.createElement('iframe');
            iframe.name = iframeName;
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            const form = document.createElement('form');
            form.method = 'PUT';
            form.action = webhookUrl;
            form.enctype = 'application/x-www-form-urlencoded';
            form.target = iframeName;
            form.style.display = 'none';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'payload';
            input.value = JSON.stringify(payload);
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();

            // Clean up after a short delay
            setTimeout(() => {
              try { document.body.removeChild(form); } catch {}
              try { document.body.removeChild(iframe); } catch {}
            }, 3000);

            return true;
          } catch (fallbackErr) {
            console.error('Fallback submission failed:', fallbackErr);
            return false;
          }
        }
      }

      function summarize(payload) {
        const el = document.getElementById('submissionSummary');
        el.innerHTML = `
          <div class="space-y-6">
            <div>
              <h4 class="font-semibold text-[var(--ns-blue)] text-lg mb-3">Company & Takeover Details</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                <div><strong>Employer/Group Name:</strong> ${payload.company.employer_name || 'N/A'}</div>
                <div><strong>Employer EIN:</strong> ${payload.company.fein || 'N/A'}</div>
                <div><strong>Primary Contact:</strong> ${payload.company.contact_name || 'N/A'}</div>
                <div><strong>Contact Email:</strong> ${payload.company.contact_email || 'N/A'}</div>
                <div><strong>Contact Phone:</strong> ${payload.company.contact_phone || 'N/A'}</div>
                <div><strong>Takeover Effective Date:</strong> ${payload.company.effective_date || 'N/A'}</div>
                <div><strong>Prior COBRA Administrator:</strong> ${payload.priorAdministrator.name || 'N/A'}</div>
                <div><strong>Prior Admin Email:</strong> ${payload.priorAdministrator.email || 'N/A'}</div>
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold text-[var(--ns-blue)] text-lg mb-3">Employee Information</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                <div><strong>Employee Name:</strong> ${payload.employee.name || 'N/A'}</div>
                <div><strong>SSN (Last 4):</strong> ${payload.employee.ssn_last4 || 'N/A'}</div>
                <div><strong>Date of Birth:</strong> ${payload.employee.dob || 'N/A'}</div>
                <div><strong>Email:</strong> ${payload.employee.email || 'N/A'}</div>
                <div><strong>Address:</strong> ${payload.employee.address1 || 'N/A'}</div>
                <div><strong>City:</strong> ${payload.employee.city || 'N/A'}</div>
                <div><strong>State:</strong> ${payload.employee.state || 'N/A'}</div>
                <div><strong>Zip:</strong> ${payload.employee.zip || 'N/A'}</div>
                <div><strong>Phone:</strong> ${payload.employee.phone || 'N/A'}</div>
                <div><strong>Gender:</strong> ${payload.employee.gender || 'N/A'}</div>
                <div><strong>Termination Date:</strong> ${payload.employee.termination_date || 'N/A'}</div>
                <div><strong>Termination Reason:</strong> ${payload.employee.termination_reason || 'N/A'}</div>
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold text-[var(--ns-blue)] text-lg mb-3">COBRA Plan Elections</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                ${payload.plans.medical ? `<div><strong>Medical:</strong> ${payload.plans.medical.carrier} - ${payload.plans.medical.tier}</div>` : ''}
                ${payload.plans.dental ? `<div><strong>Dental:</strong> ${payload.plans.dental.carrier} - ${payload.plans.dental.tier}</div>` : ''}
                ${payload.plans.vision ? `<div><strong>Vision:</strong> ${payload.plans.vision.carrier} - ${payload.plans.vision.tier}</div>` : ''}
                ${payload.plans.fsa ? `<div><strong>FSA:</strong> Initial: $${payload.plans.fsa.initial_amount_elected || 'N/A'}</div>` : ''}
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold text-[var(--ns-blue)] text-lg mb-3">COBRA Population</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                <div><strong>Active COBRA Participants:</strong> ${payload.population.active_participants}</div>
                <div><strong>Last Paid-Through Date:</strong> ${payload.population.last_paid_through || 'N/A'}</div>
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold text-[var(--ns-blue)] text-lg mb-3">Authorization</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                <div><strong>Authorized Signer:</strong> ${payload.authorization.auth_full_name || 'N/A'}</div>
                <div><strong>Title:</strong> ${payload.authorization.auth_title || 'N/A'}</div>
                <div><strong>Date:</strong> ${payload.authorization.auth_date || 'N/A'}</div>
                <div><strong>Signature:</strong> ${payload.authorization.signature ? 'âœ“ Provided' : 'Not provided'}</div>
              </div>
            </div>
          </div>
        `;
      }

      // Add button ripple effect on click
      function createRipple(event) {
        const button = event.currentTarget;
        const ripple = document.createElement('span');
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = event.clientX - rect.left - size / 2;
        const y = event.clientY - rect.top - size / 2;
        
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        ripple.classList.add('ripple');
        
        button.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);
      }

      prevBtn.addEventListener('click', (e) => {
        if (currentStep > 1) {
          // Animate button
          anime({
            targets: prevBtn,
            scale: [1, 0.95, 1],
            duration: 200
          });
          
          showStep(currentStep - 1);
        }
      });

      nextBtn.addEventListener('click', async (e) => {
        if (!validateStep(currentStep)) {
          // Shake animation for invalid form
          anime({
            targets: steps[currentStep - 1],
            translateX: [0, -10, 10, -10, 10, 0],
            duration: 500,
            easing: 'easeInOutQuad'
          });
          
          // Show error notification with animation
          const errorDiv = document.createElement('div');
          errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          errorDiv.innerHTML = 'âš ï¸ Please complete all required fields';
          document.body.appendChild(errorDiv);
          
          anime({
            targets: errorDiv,
            translateX: [100, 0],
            opacity: [0, 1],
            duration: 400,
            easing: 'easeOutCubic',
            complete: () => {
              setTimeout(() => {
                anime({
                  targets: errorDiv,
                  translateX: [0, 100],
                  opacity: [1, 0],
                  duration: 400,
                  complete: () => errorDiv.remove()
                });
              }, 3000);
            }
          });
          return;
        }
        
        // Animate button
        anime({
          targets: nextBtn,
          scale: [1, 0.95, 1],
          duration: 200
        });
        
        if (currentStep === totalSteps - 1) {
          nextBtn.disabled = true;
          nextBtn.textContent = 'Submitting...';
          
          // Add loading animation
          anime({
            targets: nextBtn,
            scale: [1, 1.05, 1],
            loop: true,
            duration: 800,
            easing: 'easeInOutQuad'
          });
          
          const data = await toJSONPayload();
          const ok = await submitToWebhook();
          
          // Stop the loading animation
          anime.remove(nextBtn);
          
          // Clear localStorage on successful submission
          localStorage.removeItem('cobraFormProgress');
          
          summarize(data);
          showStep(totalSteps);
          announceToScreenReader('Form submitted successfully!');
          nextBtn.disabled = false;
          nextBtn.textContent = 'Next â†’';
          return;
        }
        
        showStep(currentStep + 1);
      });



      document.getElementById('startOverBtn')?.addEventListener('click', () => {
        if (!confirm('Start a new submission? This will clear the current data.')) return;
        
        // Animate transition back to start
        anime({
          targets: mainFormCard,
          opacity: [1, 0],
          scale: [1, 0.95],
          duration: 400,
          easing: 'easeInCubic',
          complete: () => {
            form.reset();
            if (sigPad) sigPad.clear();
            formStarted = false;
            currentStep = 1;
            formData = {};
            
            // Clear saved progress
            localStorage.removeItem('cobraFormProgress');
            
            mainFormCard.classList.remove('step-active');
            mainFormCard.classList.add('step-hidden');
            
            // Hide journey tracker
            const journeyTracker = document.getElementById('journeyTracker');
            if (journeyTracker) {
              anime({
                targets: journeyTracker,
                opacity: [1, 0],
                translateY: [0, -30],
                duration: 400,
                easing: 'easeInCubic',
                complete: () => {
                  journeyTracker.classList.add('step-hidden');
                  // Reset journey step cards
                  for (let i = 1; i <= totalSteps; i++) {
                    const journeyStep = document.getElementById(`journey-step-${i}`);
                    if (journeyStep) {
                      journeyStep.className = 'journey-step';
                      if (i === 1) {
                        journeyStep.classList.add('active');
                      } else {
                        journeyStep.classList.add('pending');
                      }
                      const checkmark = journeyStep.querySelector('.journey-checkmark');
                      if (checkmark) {
                        checkmark.classList.add('hidden');
                      }
                    }
                  }
                }
              });
            }
            
            processDiagram.classList.remove('step-hidden');
            processDiagram.classList.add('step-active');
            
            anime({
              targets: processDiagram,
              opacity: [0, 1],
              scale: [0.95, 1],
              duration: 600,
              easing: 'easeOutCubic',
              complete: () => {
                announceToScreenReader('Form reset. Ready to start new submission.');
              }
            });
          }
        });
      });
      
      // Add focus animations to inputs
      document.querySelectorAll('input:not([type="radio"]):not([type="checkbox"]), select, textarea').forEach(input => {
        input.addEventListener('focus', function() {
          anime({
            targets: this,
            scale: [1, 1.02, 1],
            duration: 300,
            easing: 'easeOutCubic'
          });
        });
      });
      
      // Enhance "Add Employee" button
      const addEmployeeBtn = document.getElementById('addEmployeeBtn');
      if (addEmployeeBtn) {
        addEmployeeBtn.addEventListener('click', function() {
          // Button animation
          anime({
            targets: this,
            scale: [1, 0.95, 1],
            duration: 200
          });
        });
      }

      // Defaults
      const today = new Date().toISOString().split('T')[0];
      const authDate = form.querySelector('input[name="auth_date"]');
      if (authDate) authDate.value = today;
      
      // Set the print date immediately
      const printDateEl = document.getElementById('printDate');
      if (printDateEl) printDateEl.textContent = new Date().toLocaleString();
      // Mask SSN: keep only last 4 visible in placeholder/input and store last4 in hidden field
      const ssnInput = document.getElementById('employee_ssn');
      const ssnHidden = document.getElementById('employee_ssn_last4');
      function maskSSN(value) {
        const digits = (value || '').replace(/\D/g, '').slice(0, 9);
        const last4 = digits.slice(-4);
        if (ssnHidden) ssnHidden.value = last4;
        // show only last 4 with ***-**- prefix
        return last4 ? `***-**-${last4}` : '';
      }
      if (ssnInput) {
        ssnInput.addEventListener('input', (e) => {
          const v = e.target.value;
          const masked = maskSSN(v);
          e.target.value = masked;
        });
        ssnInput.addEventListener('blur', (e) => {
          const v = e.target.value;
          e.target.value = maskSSN(v);
        });
      }
      
      // Format phone number as (XXX) XXX-XXXX
      const phoneInput = document.getElementById('employee_phone');
      function formatPhone(value) {
        const digits = (value || '').replace(/\D/g, '').slice(0, 10);
        if (digits.length === 0) return '';
        if (digits.length <= 3) return `(${digits}`;
        if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
        return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
      }
      if (phoneInput) {
        phoneInput.addEventListener('input', (e) => {
          const v = e.target.value;
          const formatted = formatPhone(v);
          e.target.value = formatted;
        });
        phoneInput.addEventListener('blur', (e) => {
          const v = e.target.value;
          e.target.value = formatPhone(v);
        });
      }
      
      // Add Additional Employee functionality (original handler preserved)
      let employeeCount = 1;
      
      if (addEmployeeBtn) {
        const originalHandler = addEmployeeBtn.onclick;
        addEmployeeBtn.addEventListener('click', () => {
          employeeCount++;
          const employeeSection = document.querySelector('[data-step="2"]');
          const addButtonDiv = employeeSection.querySelector('.mt-6.text-center');
          
          const newEmployeeDiv = document.createElement('div');
          newEmployeeDiv.className = 'mt-8 p-6 border-2 border-slate-200 rounded-lg bg-slate-50';
          newEmployeeDiv.innerHTML = `
            <h4 class="text-lg font-semibold text-[var(--ns-blue)] mb-4">Employee ${employeeCount}</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Employee Full Name <span class="text-red-500">*</span></label>
                <input name="employee_name_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Division/Department</label>
                <input name="employee_division_${employeeCount}" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">SSN (masked) <span class="text-red-500">*</span></label>
                <input name="employee_ssn_${employeeCount}" inputmode="numeric" autocomplete="off" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="***-**-1234" />
                <input type="hidden" name="employee_ssn_last4_${employeeCount}" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Date of Birth <span class="text-red-500">*</span></label>
                <input type="date" name="employee_dob_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Email <span class="text-red-500">*</span></label>
                <input type="email" name="employee_email_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700">Address Line 1 <span class="text-red-500">*</span></label>
                <input name="employee_address1_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700">Address Line 2</label>
                <input name="employee_address2_${employeeCount}" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">City <span class="text-red-500">*</span></label>
                <input name="employee_city_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">State <span class="text-red-500">*</span></label>
                <select name="employee_state_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2">
                  <option value="">Select State</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="DC">District of Columbia</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Zip <span class="text-red-500">*</span></label>
                <input name="employee_zip_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Phone <span class="text-red-500">*</span></label>
                <input name="employee_phone_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="(913) 555-5555" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Gender <span class="text-red-500">*</span></label>
                <select name="employee_gender_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2">
                  <option value="">Select Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Date of Termination <span class="text-red-500">*</span></label>
                <input type="date" name="employee_termination_date_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Reason for Termination <span class="text-red-500">*</span></label>
                <input name="employee_termination_reason_${employeeCount}" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>
            <div class="mt-4 text-right">
              <button type="button" class="remove-employee-btn px-3 py-1 rounded bg-red-600 text-white text-sm hover:bg-red-700" onclick="this.closest('.mt-8').remove()">Remove Employee</button>
            </div>
          `;
          
          // Insert the new employee section before the add button
          addButtonDiv.parentNode.insertBefore(newEmployeeDiv, addButtonDiv);
          
          // Add event listeners for the new fields
          const newSSNInput = newEmployeeDiv.querySelector(`input[name="employee_ssn_${employeeCount}"]`);
          const newSSNHidden = newEmployeeDiv.querySelector(`input[name="employee_ssn_last4_${employeeCount}"]`);
          const newPhoneInput = newEmployeeDiv.querySelector(`input[name="employee_phone_${employeeCount}"]`);
          
          // Add SSN masking for new employee
          if (newSSNInput && newSSNHidden) {
            newSSNInput.addEventListener('input', (e) => {
              const v = e.target.value;
              const masked = maskSSN(v);
              e.target.value = masked;
            });
            newSSNInput.addEventListener('blur', (e) => {
              const v = e.target.value;
              e.target.value = maskSSN(v);
            });
          }
          
          // Add phone formatting for new employee
          if (newPhoneInput) {
            newPhoneInput.addEventListener('input', (e) => {
              const v = e.target.value;
              const formatted = formatPhone(v);
              e.target.value = formatted;
            });
            newPhoneInput.addEventListener('blur', (e) => {
              const v = e.target.value;
              e.target.value = formatPhone(v);
            });
          }
        });
      }
      
      // Confetti celebration effect
      function createConfetti() {
        const colors = ['#A4C639', '#1E4E6B', '#8fb332', '#2a5f7a'];
        const confettiCount = 50;
        
        for (let i = 0; i < confettiCount; i++) {
          setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.width = (Math.random() * 10 + 5) + 'px';
            confetti.style.height = confetti.style.width;
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            confetti.style.animationDelay = (Math.random() * 0.5) + 's';
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 4000);
          }, i * 30);
        }
      }
      
      // Header scroll effect
      let lastScroll = 0;
      window.addEventListener('scroll', () => {
        const header = document.querySelector('header');
        const currentScroll = window.pageYOffset;
        
        if (currentScroll > 50) {
          header.classList.add('scrolled');
        } else {
          header.classList.remove('scrolled');
        }
        
        lastScroll = currentScroll;
      });
      
      // Template download buttons
      document.getElementById('rosterTemplateBtn')?.addEventListener('click', () => {
        const header = ['employee_name', 'ssn', 'dob', 'address', 'city', 'state', 'zip', 'phone', 'coverage_tier', 'premium_amount'];
        const csv = header.join(',') + '\n';
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cobra-roster-template.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
      
      document.getElementById('rateSheetTemplateBtn')?.addEventListener('click', () => {
        alert('Rate Sheet Template: Please contact your administrator for the PDF template.');
      });
      
      // Dependent rows functionality
      const depTable = document.getElementById('depTable');
      function addDepRow(prefill = {}) {
        const id = 'd_' + Math.random().toString(36).slice(2, 8);
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 sm:grid-cols-12 gap-3 items-end rounded-lg border-2 border-slate-200 p-3';
        row.innerHTML = `
          <div class="sm:col-span-4">
            <label class="block text-sm text-slate-700">Full Name</label>
            <input name="deps[${id}][name]" value="${prefill.name || ''}" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
          </div>
          <div class="sm:col-span-3">
            <label class="block text-sm text-slate-700">Date of Birth</label>
            <input type="date" name="deps[${id}][dob]" value="${prefill.dob || ''}" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
          </div>
          <div class="sm:col-span-3">
            <label class="block text-sm text-slate-700">SSN</label>
            <input name="deps[${id}][ssn_display]" data-dep-ssn-display value="${prefill.ssn || ''}" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="###-##-####" />
            <input type="hidden" name="deps[${id}][ssn]" data-dep-ssn-hidden />
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm text-slate-700">Relationship</label>
            <select name="deps[${id}][rel]" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2">
              <option value="">Select...</option>
              <option ${prefill.rel === 'Spouse' ? 'selected' : ''}>Spouse</option>
              <option ${prefill.rel === 'Child' ? 'selected' : ''}>Child</option>
            </select>
          </div>
          <div class="sm:col-span-12 text-right">
            <button type="button" class="text-sm text-red-600" data-remove>Remove</button>
          </div>`;
        row.querySelector('[data-remove]')?.addEventListener('click', () => row.remove());
        depTable.appendChild(row);
        
        // Attach SSN mask handlers for dependent row
        const dDisplay = row.querySelector('[data-dep-ssn-display]');
        const dHidden = row.querySelector('[data-dep-ssn-hidden]');
        function fmt(d) {
          if (d.length <= 3) return d;
          if (d.length <= 5) return d.slice(0, 3) + '-' + d.slice(3);
          return d.slice(0, 3) + '-' + d.slice(3, 5) + '-' + d.slice(5, 9);
        }
        function mask(d) {
          if (d.length < 4) return ''.padStart(d.length, 'â€¢');
          return 'â€¢â€¢â€¢-â€¢â€¢-' + d.slice(-4);
        }
        if (dDisplay && dHidden) {
          dDisplay.addEventListener('input', () => {
            const digits = dDisplay.value.replace(/\D/g, '').slice(0, 9);
            dHidden.value = digits;
            dDisplay.value = fmt(digits);
          });
          dDisplay.addEventListener('blur', () => {
            const digits = (dHidden.value || '').replace(/\D/g, '');
            if (digits.length === 9) {
              dDisplay.value = mask(digits);
            }
          });
          dDisplay.addEventListener('focus', () => {
            const digits = (dHidden.value || '').replace(/\D/g, '');
            dDisplay.value = fmt(digits);
          });
        }
      }
      
      document.getElementById('addDepBtn')?.addEventListener('click', () => addDepRow());
      // Seed a few empty rows
      addDepRow();
      addDepRow();
      addDepRow();
      
      // Initial page load animations
      window.addEventListener('load', () => {
        // Animate process diagram on load
        anime({
          targets: processDiagram,
          opacity: [0, 1],
          translateY: [30, 0],
          duration: 800,
          easing: 'easeOutCubic',
          delay: 200
        });
        
        // Animate mermaid diagram elements
        setTimeout(() => {
          const mermaidElements = document.querySelectorAll('.mermaid svg');
          if (mermaidElements.length > 0) {
            anime({
              targets: mermaidElements,
              opacity: [0, 1],
              scale: [0.9, 1],
              duration: 1000,
              easing: 'easeOutElastic(1, .6)'
            });
          }
        }, 600);
        
        // Animate start button with pulse
        anime({
          targets: startFormBtn,
          scale: [1, 1.05, 1],
          duration: 2000,
          loop: true,
          easing: 'easeInOutQuad'
        });
      });
      
      // Add keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!formStarted) return;
        
        // Alt + Right Arrow = Next
        if (e.altKey && e.key === 'ArrowRight' && currentStep < totalSteps - 1) {
          nextBtn.click();
        }
        // Alt + Left Arrow = Previous
        if (e.altKey && e.key === 'ArrowLeft' && currentStep > 1) {
          prevBtn.click();
        }
      });
      
      // Show keyboard shortcut hints
      if (formStarted) {
        const shortcutHint = document.createElement('div');
        shortcutHint.className = 'fixed bottom-4 left-4 bg-slate-800 text-white text-xs px-3 py-2 rounded-lg opacity-50 hover:opacity-100 transition-opacity';
        shortcutHint.innerHTML = 'ðŸ’¡ Tip: Use <kbd class="bg-slate-700 px-1 rounded">Alt+â†</kbd> and <kbd class="bg-slate-700 px-1 rounded">Alt+â†’</kbd> to navigate';
        document.body.appendChild(shortcutHint);
        
        // Fade in hint
        anime({
          targets: shortcutHint,
          opacity: [0, 0.5],
          translateY: [20, 0],
          duration: 600,
          delay: 2000
        });
      }
      
      // Don't call showStep on initial load since we're showing the diagram first
      // showStep(currentStep);
    })();
  </script>
</body>
</html>