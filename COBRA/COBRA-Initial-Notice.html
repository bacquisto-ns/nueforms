<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NueSynergy COBRA Initial Notice</title>
  
  <!-- Performance: Preload critical resources -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style">
  <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
  
  <!-- CSS Frameworks & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Animation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  
  <style>
    :root {
      /* Primary Brand Colors */
      --primary-blue: #1E4E6B;
      --primary-blue-light: #2a5f7a;
      --accent-green: #A4C639;
      --accent-green-hover: #8fb332;
      --accent-green-dark: #4a5d23;
      
      /* Text Colors */
      --text-primary: #2d3748;
      --text-secondary: #64748b;
      --text-white: #ffffff;
      
      /* Background Colors */
      --bg-primary: #f0f4f8;
      --bg-secondary: #e8f2f6;
      --bg-card: #ffffff;
      --bg-section: #f8fafc;
      --bg-section-end: #f1f5f9;
      
      /* Border & Accent Colors */
      --border-default: #e2e8f0;
      --border-focus: var(--accent-green);
      --error: #e53e3e;
      --error-hover: #c53030;
    }
    
    html, body { height: 100%; }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%); 
      color: var(--text-primary); 
    }
    
    /* Skip link for accessibility */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--primary-blue);
      color: white;
      padding: 8px;
      text-decoration: none;
      z-index: 100;
    }
    .skip-link:focus {
      top: 0;
    }
    
    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    
    .card { 
      background: white; 
      border-radius: 16px; 
      box-shadow: 0 20px 40px rgba(30, 78, 107, 0.1); 
      transition: all 0.3s ease;
    }
    
    .step-active { display: block; }
    .step-hidden { display: none; }
    
    .sig-pad { 
      border: 2px solid rgba(164, 198, 57, 0.8); 
      border-radius: 8px; 
      background: white; 
    }
    
    /* Header with animation */
    header.animate-in {
      animation: fadeInDown 1.2s ease-out;
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Section styling */
    section.step {
      padding: 30px;
      background: linear-gradient(135deg, var(--bg-section) 0%, var(--bg-section-end) 100%);
      border-radius: 12px;
      border-left: 4px solid var(--accent-green);
      transition: all 0.3s ease;
    }
    
    section.step:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    /* Form inputs */
    input:not([type="checkbox"]):not([type="radio"]),
    select,
    textarea {
      transition: all 0.3s ease;
    }
    
    input:not([type="checkbox"]):not([type="radio"]):focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent-green);
      box-shadow: 0 0 0 3px rgba(164, 198, 57, 0.1);
      transform: translateY(-1px);
    }
    
    /* Buttons */
    button {
      transition: all 0.3s ease;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
    }
    
    /* Error states */
    .field-error, .ring-red-500 {
      border-color: var(--error) !important;
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1) !important;
    }
    
    /* Pulse animation */
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    
    /* Journey Tracker Cards */
    .journey-step {
      position: relative;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.5rem 1rem;
      transition: all 0.3s ease;
      cursor: default;
      overflow: hidden;
    }
    
    .journey-step::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, transparent, var(--accent-green), transparent);
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }
    
    .journey-step:hover::before {
      transform: translateX(100%);
    }
    
    .journey-icon-wrapper {
      position: relative;
      width: 60px;
      height: 60px;
      margin: 0 auto 1rem;
      background: linear-gradient(135deg, #f0f4f0 0%, #e5e7eb 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .journey-icon {
      font-size: 1.5rem;
      color: #6b7280;
      transition: all 0.3s ease;
    }
    
    .journey-number {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .journey-checkmark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 70px;
      height: 70px;
      background: var(--accent-green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 2;
    }
    
    .journey-checkmark i {
      color: white;
      font-size: 1.75rem;
      font-weight: bold;
    }
    
    .journey-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }
    
    .journey-description {
      font-size: 0.75rem;
      color: #9ca3af;
      line-height: 1.3;
      transition: all 0.3s ease;
    }
    
    /* ACTIVE STATE - Current Step */
    .journey-step.active {
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);
      border-color: var(--accent-green);
      box-shadow: 0 8px 24px rgba(164, 198, 57, 0.3);
      transform: translateY(-4px);
    }
    
    .journey-step.active .journey-icon-wrapper {
      background: rgba(255, 255, 255, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }
    
    .journey-step.active .journey-icon {
      color: white;
      transform: scale(1.1);
    }
    
    .journey-step.active .journey-number {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      box-shadow: 0 4px 12px rgba(30, 78, 107, 0.4);
    }
    
    .journey-step.active .journey-title,
    .journey-step.active .journey-description {
      color: white;
    }
    
    /* COMPLETED STATE - Past Steps */
    .journey-step.completed {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      border-color: var(--primary-blue);
      box-shadow: 0 4px 16px rgba(30, 78, 107, 0.2);
    }
    
    .journey-step.completed .journey-icon-wrapper {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .journey-step.completed .journey-icon {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .journey-step.completed .journey-checkmark {
      transform: translate(-50%, -50%) scale(1);
    }
    
    .journey-step.completed .journey-checkmark.hidden {
      display: flex !important;
    }
    
    .journey-step.completed .journey-number {
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);
    }
    
    .journey-step.completed .journey-title,
    .journey-step.completed .journey-description {
      color: white;
    }
    
    /* PENDING STATE - Future Steps */
    .journey-step.pending {
      opacity: 0.7;
    }
    
    .journey-step.pending:hover {
      opacity: 0.85;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* Shimmer Effect */
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(200%); }
    }
    
    .animate-shimmer {
      animation: shimmer 2s infinite;
    }
    
    /* Responsive Design for Journey Cards */
    @media (max-width: 768px) {
      .journey-step {
        padding: 1rem 0.75rem;
      }
      
      .journey-icon-wrapper {
        width: 50px;
        height: 50px;
      }
      
      .journey-icon {
        font-size: 1.25rem;
      }
      
      .journey-number {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
      }
      
      .journey-title {
        font-size: 0.85rem;
      }
      
      .journey-description {
        font-size: 0.7rem;
      }
    }
    
    /* Reduce motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      .card { box-shadow: none; border: 1px solid #ddd; border-radius: 0; }
      .sig-pad { border: 1px solid #ccc; }
      body { background: #fff; color: #000; }
    }
  </style>
</head>
<body>
  <!-- Skip link for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <!-- Screen reader announcements -->
  <div id="status-message" class="sr-only" role="status" aria-live="polite"></div>
  <div id="error-message" class="sr-only" role="alert" aria-live="assertive"></div>
  
  <div class="min-h-full">
    <header class="relative overflow-hidden animate-in" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col items-start gap-3 text-white">
          <h1 class="text-3xl sm:text-4xl font-bold drop-shadow">NueSynergy</h1>
          <p class="text-lg opacity-90">EMPLOYEE FOCUSED ASSISTANCE</p>
          <p class="text-sm opacity-75">
            <i class="fas fa-phone mr-2"></i>1-800-413-4138 | 
            <i class="fas fa-envelope ml-3 mr-2"></i>info@nuesynergy.com
          </p>
          <h2 class="mt-3 text-xl text-[var(--accent-green)] font-semibold">
            <i class="fas fa-file-contract mr-2"></i>COBRA Initial Notice
          </h2>
        </div>
      </div>
    </header>

    <main id="main-content" class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8 mt-5">
      <div class="card p-6 sm:p-8">
        <!-- Progress Tracker -->
        <nav role="navigation" aria-label="Form progress" class="mb-8">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-2xl font-bold flex items-center" style="color: var(--primary-blue);">
                <i class="fas fa-route mr-3 text-3xl" style="color: var(--accent-green);"></i>Your Journey
              </h3>
              <p class="text-sm mt-1 ml-12" style="color: var(--text-secondary);">Track your progress through the form</p>
            </div>
            <div class="text-right">
              <span class="text-3xl font-bold" style="color: var(--accent-green);" id="progressText">Step 1</span>
              <p class="text-sm" style="color: var(--text-secondary);">of 6 steps</p>
            </div>
          </div>
          
          <!-- Animated Progress Bar -->
          <div class="relative w-full bg-gray-200 rounded-full h-3 mb-8 overflow-hidden">
            <div id="progressFill" class="h-3 rounded-full transition-all duration-700 ease-out relative" 
                 style="width: 16.67%; background: linear-gradient(90deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);">
              <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-shimmer"></div>
            </div>
          </div>
          
          <!-- Interactive Step Cards -->
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            <!-- Step 1: Employer -->
            <div class="journey-step active" id="journey-step-1" data-step="1">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-building journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="journey-number">1</div>
                </div>
                <h4 class="journey-title">Employer</h4>
                <p class="journey-description">Organization details</p>
              </div>
            </div>
            
            <!-- Step 2: Beneficiary -->
            <div class="journey-step pending" id="journey-step-2" data-step="2">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-user journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="journey-number">2</div>
                </div>
                <h4 class="journey-title">Beneficiary</h4>
                <p class="journey-description">Employee information</p>
              </div>
            </div>
            
            <!-- Step 3: Event -->
            <div class="journey-step pending" id="journey-step-3" data-step="3">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-calendar-alt journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="journey-number">3</div>
                </div>
                <h4 class="journey-title">Event</h4>
                <p class="journey-description">Qualifying event</p>
              </div>
            </div>
            
            <!-- Step 4: Plans -->
            <div class="journey-step pending" id="journey-step-4" data-step="4">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-file-medical journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="journey-number">4</div>
                </div>
                <h4 class="journey-title">Plans</h4>
                <p class="journey-description">Coverage options</p>
              </div>
            </div>
            
            <!-- Step 5: Signature -->
            <div class="journey-step pending" id="journey-step-5" data-step="5">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-signature journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="journey-number">5</div>
                </div>
                <h4 class="journey-title">Sign</h4>
                <p class="journey-description">Authorization</p>
              </div>
            </div>
            
            <!-- Step 6: Complete -->
            <div class="journey-step pending" id="journey-step-6" data-step="6">
              <div class="journey-step-inner">
                <div class="journey-icon-wrapper">
                  <i class="fas fa-check-circle journey-icon"></i>
                  <div class="journey-checkmark hidden">
                    <i class="fas fa-check"></i>
                  </div>
                  <div class="journey-number">6</div>
                </div>
                <h4 class="journey-title">Complete</h4>
                <p class="journey-description">Confirmation</p>
              </div>
            </div>
          </div>
        </nav>

        <form id="cobraInitialForm" class="space-y-8">
          <!-- Step 1: Employer / Plan Sponsor Details -->
          <section data-step="1" class="step step-active">
            <h3 class="text-xl font-semibold text-center flex items-center justify-center gap-3 mb-2" style="color: var(--primary-blue);">
              <i class="fas fa-building text-2xl" style="color: var(--accent-green);"></i>
              Employer / Plan Sponsor Details
            </h3>
            <p class="text-center mb-5" style="color: var(--text-secondary);">Provide your organization and contact information.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Employer/Group Name <span class="text-red-500">*</span></label>
                <input name="employer_name" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--ns-green)]" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">FEIN</label>
                <input name="fein" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Primary Contact Name <span class="text-red-500">*</span></label>
                <input name="contact_name" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Primary Contact Email <span class="text-red-500">*</span></label>
                <input type="email" name="contact_email" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Primary Contact Phone</label>
                <input type="tel" name="contact_phone" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Notice Issue Date <span class="text-red-500">*</span></label>
                <input type="date" name="notice_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>
          </section>

          <!-- Step 2: Qualified Beneficiary -->
          <section data-step="2" class="step step-hidden">
            <h3 class="text-xl font-semibold text-center flex items-center justify-center gap-3 mb-2" style="color: var(--primary-blue);">
              <i class="fas fa-user text-2xl" style="color: var(--accent-green);"></i>
              Qualified Beneficiary
            </h3>
            <p class="text-center mb-5" style="color: var(--text-secondary);">Provide the employee (and dependents) receiving this notice.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Employee Full Name <span class="text-red-500">*</span></label>
                <input name="employee_name" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Employee SSN (masked)</label>
                <input id="employee_ssn" name="employee_ssn" inputmode="numeric" autocomplete="off" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="***-**-1234" />
                <input type="hidden" id="employee_ssn_last4" name="employee_ssn_last4" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Employee Date of Birth</label>
                <input type="date" name="employee_dob" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Employee Email</label>
                <input type="email" name="employee_email" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700">Mailing Address</label>
                <input name="employee_address1" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="Address line 1" />
                <input name="employee_address2" class="mt-3 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="Address line 2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">City</label>
                <input name="employee_city" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">State</label>
                <input name="employee_state" maxlength="2" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2 uppercase" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Zip</label>
                <input name="employee_zip" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>

            <div class="mt-6">
              <div class="flex items-center justify-between">
                <h4 class="text-[var(--ns-blue)] font-semibold">Dependents</h4>
                <button type="button" id="addDepBtn" class="px-3 py-1.5 text-sm rounded bg-[var(--ns-blue)] text-white">Add Dependent</button>
              </div>
              <p class="text-xs text-slate-500 mt-1">Optional. Add spouse/children who may also be qualified beneficiaries.</p>
              <div id="dependentsContainer" class="mt-3 space-y-3"></div>
            </div>
          </section>

          <!-- Step 3: Qualifying Event -->
          <section data-step="3" class="step step-hidden">
            <h3 class="text-xl font-semibold text-center flex items-center justify-center gap-3 mb-2" style="color: var(--primary-blue);">
              <i class="fas fa-calendar-alt text-2xl" style="color: var(--accent-green);"></i>
              Qualifying Event
            </h3>
            <p class="text-center mb-5" style="color: var(--text-secondary);">Specify the event and dates that triggered COBRA eligibility.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Event Type <span class="text-red-500">*</span></label>
                <select name="event_type" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2">
                  <option value="">Select...</option>
                  <option>Termination of employment (other than gross misconduct)</option>
                  <option>Reduction in hours</option>
                  <option>Divorce or legal separation</option>
                  <option>Death of employee</option>
                  <option>Dependent child aging out</option>
                  <option>Medicare entitlement of employee</option>
                  <option>Employer bankruptcy (retiree)</option>
                  <option>Other</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Event Date <span class="text-red-500">*</span></label>
                <input type="date" name="event_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Coverage Loss Date</label>
                <input type="date" name="loss_date" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Maximum Coverage Duration</label>
                <div class="mt-1 flex flex-wrap gap-4 text-sm">
                  <label class="inline-flex items-center gap-2"><input type="radio" name="max_months" value="18" class="h-4 w-4 accent-[var(--ns-green)]" /> 18 months</label>
                  <label class="inline-flex items-center gap-2"><input type="radio" name="max_months" value="29" class="h-4 w-4 accent-[var(--ns-green)]" /> 29 months (disability extension)</label>
                  <label class="inline-flex items-center gap-2"><input type="radio" name="max_months" value="36" class="h-4 w-4 accent-[var(--ns-green)]" /> 36 months</label>
                </div>
              </div>
            </div>

            <div class="mt-6">
              <label class="block text-sm font-medium text-slate-700">Supporting Documents (optional)</label>
              <input id="file_supporting" type="file" multiple class="mt-1 block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-medium file:bg-[var(--ns-blue)] file:text-white hover:file:opacity-90" />
            </div>
          </section>

          <!-- Step 4: Plans & Premiums -->
          <section data-step="4" class="step step-hidden">
            <h3 class="text-xl font-semibold text-center flex items-center justify-center gap-3 mb-2" style="color: var(--primary-blue);">
              <i class="fas fa-file-medical text-2xl" style="color: var(--accent-green);"></i>
              Plans Offered for COBRA & Premiums
            </h3>
            <p class="text-center mb-5" style="color: var(--text-secondary);">List available plans and applicable monthly premiums and admin fee (if any).</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Medical -->
              <div class="rounded-lg border-2 border-slate-200 p-4">
                <label class="flex items-center gap-3 text-[var(--ns-blue)] font-semibold">
                  <input type="checkbox" name="offer_medical" class="h-5 w-5 accent-[var(--ns-green)]" /> Medical
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Carrier</label>
                    <input name="medical_carrier" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Monthly Premium</label>
                    <input name="medical_premium" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Admin Fee %</label>
                    <input name="medical_admin_pct" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="e.g., 2" />
                  </div>
                </div>
              </div>

              <!-- Dental -->
              <div class="rounded-lg border-2 border-slate-200 p-4">
                <label class="flex items-center gap-3 text-[var(--ns-blue)] font-semibold">
                  <input type="checkbox" name="offer_dental" class="h-5 w-5 accent-[var(--ns-green)]" /> Dental
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Carrier</label>
                    <input name="dental_carrier" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Monthly Premium</label>
                    <input name="dental_premium" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Admin Fee %</label>
                    <input name="dental_admin_pct" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="e.g., 2" />
                  </div>
                </div>
              </div>

              <!-- Vision -->
              <div class="rounded-lg border-2 border-slate-200 p-4">
                <label class="flex items-center gap-3 text-[var(--ns-blue)] font-semibold">
                  <input type="checkbox" name="offer_vision" class="h-5 w-5 accent-[var(--ns-green)]" /> Vision
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Carrier</label>
                    <input name="vision_carrier" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Monthly Premium</label>
                    <input name="vision_premium" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Admin Fee %</label>
                    <input name="vision_admin_pct" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="e.g., 2" />
                  </div>
                </div>
              </div>

              <!-- FSA -->
              <div class="rounded-lg border-2 border-slate-200 p-4">
                <label class="flex items-center gap-3 text-[var(--ns-blue)] font-semibold">
                  <input type="checkbox" name="offer_fsa" class="h-5 w-5 accent-[var(--ns-green)]" /> FSA
                </label>
                <p class="mt-2 text-xs italic text-slate-600">If FSA is eligible for continuation, provide details.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm text-slate-700">Monthly Premium</label>
                    <input name="fsa_premium" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="$" />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-700">Admin Fee %</label>
                    <input name="fsa_admin_pct" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="e.g., 2" />
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Initial Premium Due Date (after election)</label>
                <input type="date" name="initial_due" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Monthly Payment Due Day</label>
                <input type="number" min="1" max="31" name="monthly_due_day" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="e.g., 1 for the 1st" />
              </div>
            </div>
          </section>

          <!-- Step 5: Notices & Signature -->
          <section data-step="5" class="step step-hidden">
            <h3 class="text-xl font-semibold text-center flex items-center justify-center gap-3 mb-2" style="color: var(--primary-blue);">
              <i class="fas fa-signature text-2xl" style="color: var(--accent-green);"></i>
              Notices & Acknowledgment
            </h3>
            <p class="text-center mb-5" style="color: var(--text-secondary);">Review COBRA rights and confirm delivery of this notice.</p>

            <div class="rounded-lg border-2 border-slate-200 p-4 bg-slate-50 space-y-3 text-sm">
              <p><strong>COBRA Rights:</strong> You have the right to choose continuation coverage for the group health plan(s) you were enrolled in on the day before the qualifying event. You generally have 60 days from the later of the date of this notice or the date of loss of coverage to elect COBRA coverage. The initial payment is due within 45 days of your election; subsequent monthly payments typically have a 30-day grace period.</p>
              <p>Failure to elect or pay premiums timely may result in loss of continuation coverage. COBRA coverage is generally available for up to 18 months (or 29 months with disability extension, or 36 months depending on the qualifying event).</p>
              <p>For questions, contact NueSynergy or your Employer/Plan Sponsor contact listed above.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
              <div>
                <label class="block text-sm font-medium text-slate-700">Prepared By (Employer) <span class="text-red-500">*</span></label>
                <input name="prepared_by" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Title</label>
                <input name="prepared_title" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Date <span class="text-red-500">*</span></label>
                <input type="date" name="prepared_date" required class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" />
              </div>
            </div>

            <div class="mt-3">
              <label class="block text-sm font-medium text-slate-700 mb-2">Employer Signature <span class="text-red-500">*</span></label>
              <canvas id="sigPad" class="sig-pad w-full h-48"></canvas>
              <div class="mt-2 flex gap-2">
                <button type="button" id="sigClear" class="px-3 py-2 rounded bg-slate-600 text-white text-sm">Clear</button>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-700">Send copy to Beneficiary Email (optional)</label>
                <input type="email" name="beneficiary_email_copy" class="mt-1 block w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="name@example.com" />
              </div>
              <div class="flex items-start gap-3">
                <input id="ack" type="checkbox" class="mt-6 h-4 w-4 accent-[var(--ns-green)]" required />
                <label for="ack" class="mt-5 text-sm text-slate-700">I certify this COBRA Initial Notice and premium information is accurate and was (or will be) delivered to the qualified beneficiary.</label>
              </div>
            </div>
          </section>

          <!-- Step 6: Confirmation -->
          <section data-step="6" class="step step-hidden">
            <div class="text-center">
              <div class="mx-auto w-20 h-20 rounded-full flex items-center justify-center text-white text-3xl font-bold" style="background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%);">
                <i class="fas fa-check"></i>
              </div>
              <h3 class="mt-4 text-2xl font-semibold" style="color: var(--primary-blue);">Notice Recorded</h3>
              <p class="mt-2 text-slate-600">Your COBRA Initial Notice has been recorded. You can print or download the data below.</p>
              <div id="submissionSummary" class="mt-6 text-left mx-auto max-w-2xl p-4 bg-slate-50 rounded border border-slate-200"></div>
              <div class="mt-6 flex flex-wrap items-center justify-center gap-3">
                <button type="button" onclick="window.print()" class="px-4 py-2 rounded border-2 border-[var(--ns-blue)] text-[var(--ns-blue)] hover:bg-[var(--ns-blue)] hover:text-white">Print</button>
                <button type="button" id="downloadJsonBtn" class="px-4 py-2 rounded bg-slate-600 text-white">Download Data (JSON)</button>
                <button type="button" id="startOverBtn" class="px-4 py-2 rounded bg-[var(--ns-blue)] text-white">Start New</button>
              </div>
            </div>
          </section>

          <!-- Nav -->
          <div class="mt-6 pt-6 border-t border-slate-200 flex items-center justify-between no-print">
            <button type="button" id="prevBtn" class="px-6 py-3 rounded-lg text-white font-semibold shadow-lg" 
                    style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%); box-shadow: 0 4px 12px rgba(30, 78, 107, 0.3);">
              <i class="fas fa-arrow-left mr-2"></i>Previous
            </button>
            <div class="flex items-center gap-3">
              <button type="button" id="saveProgressBtn" class="px-4 py-2 rounded-lg border-2 text-sm font-medium" 
                      style="border-color: var(--accent-green); color: var(--accent-green);" title="Save your progress">
                <i class="fas fa-save mr-2"></i>Save Progress
              </button>
              <button type="button" id="nextBtn" class="px-6 py-3 rounded-lg text-white font-semibold shadow-lg" 
                      style="background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-hover) 100%); box-shadow: 0 4px 12px rgba(164, 198, 57, 0.3);">
                Next<i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </form>
      </div>

      <div class="print-only text-center mt-6">
        <h1 class="text-2xl font-bold" style="color: var(--ns-blue);">NueSynergy: COBRA Initial Notice</h1>
        <p class="text-slate-600">Generated on <span id="printDate"></span></p>
      </div>
    </main>
  </div>

  <script>
    'use strict';
    
    (function() {
      // Constants
      const TOTAL_STEPS = 6;
      let currentStep = 1;
      let formData = {};
      
      // Cache DOM elements
      const elements = {
        form: document.getElementById('cobraInitialForm'),
        steps: Array.from(document.querySelectorAll('section.step')),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        saveProgressBtn: document.getElementById('saveProgressBtn'),
        progressFill: document.getElementById('progressFill'),
        progressText: document.getElementById('progressText'),
        statusMessage: document.getElementById('status-message'),
        errorMessage: document.getElementById('error-message')
      };
      
      // Get journey step elements
      const journeySteps = [];
      for (let i = 1; i <= TOTAL_STEPS; i++) {
        journeySteps.push(document.getElementById(`journey-step-${i}`));
      }
      
      // Accessibility functions
      function announceToScreenReader(message) {
        if (elements.statusMessage) {
          elements.statusMessage.textContent = message;
          setTimeout(() => elements.statusMessage.textContent = '', 3000);
        }
      }
      
      function announceError(message) {
        if (elements.errorMessage) {
          elements.errorMessage.textContent = message;
          setTimeout(() => elements.errorMessage.textContent = '', 5000);
        }
      }

      // Signature Pad
      const sigCanvas = document.getElementById('sigPad');
      let sigPad;
      function initSigPad() {
        if (!sigCanvas) return;
        sigPad = new SignaturePad(sigCanvas, {
          backgroundColor: 'rgba(255,255,255,1)',
          penColor: 'rgb(0,0,0)',
          minWidth: 1.0,
          maxWidth: 2.5,
        });
        const clearBtn = document.getElementById('sigClear');
        clearBtn?.addEventListener('click', () => sigPad.clear());
        function resize() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          sigCanvas.width = sigCanvas.offsetWidth * ratio;
          sigCanvas.height = sigCanvas.offsetHeight * ratio;
          sigCanvas.getContext('2d').scale(ratio, ratio);
        }
        window.addEventListener('resize', resize);
        resize();
      }

      function showStep(n) {
        // Update step visibility
        elements.steps.forEach((s,i) => {
          s.classList.toggle('step-active', i+1 === n);
          s.classList.toggle('step-hidden', i+1 !== n);
        });
        
        // Update navigation buttons
        elements.prevBtn.style.visibility = n === 1 ? 'hidden' : 'visible';
        elements.nextBtn.innerHTML = n === TOTAL_STEPS - 1 
          ? '<i class="fas fa-check mr-2"></i>Submit' 
          : 'Next<i class="fas fa-arrow-right ml-2"></i>';
        
        if (n === TOTAL_STEPS) {
          elements.nextBtn.classList.add('hidden');
          elements.saveProgressBtn.classList.add('hidden');
        } else {
          elements.nextBtn.classList.remove('hidden');
          elements.saveProgressBtn.classList.remove('hidden');
        }
        
        // Update progress bar with animation
        const progress = ((n-1)/(TOTAL_STEPS-1))*100;
        if (elements.progressFill) {
          if (typeof anime !== 'undefined') {
            anime({
              targets: elements.progressFill,
              width: progress + '%',
              duration: 1000,
              easing: 'easeInOutQuad'
            });
          } else {
            elements.progressFill.style.width = progress + '%';
          }
        }
        
        // Update progress text
        if (elements.progressText) {
          elements.progressText.textContent = `Step ${n}`;
        }
        
        // Update journey step cards
        journeySteps.forEach((journeyStep, idx) => {
          if (!journeyStep) return;
          
          const stepNumber = idx + 1;
          journeyStep.className = 'journey-step';
          
          if (stepNumber < n) {
            // Completed step
            journeyStep.classList.add('completed');
          } else if (stepNumber === n) {
            // Active step
            journeyStep.classList.add('active');
          } else {
            // Pending step
            journeyStep.classList.add('pending');
          }
        });
        
        // Animate current step entrance and journey steps
        if (typeof anime !== 'undefined') {
          const currentStepElement = elements.steps[n-1];
          if (currentStepElement && currentStepElement.classList.contains('step-active')) {
            anime({
              targets: currentStepElement,
              opacity: [0, 1],
              translateX: [50, 0],
              duration: 800,
              easing: 'easeOutExpo'
            });
            
            // Animate form groups within the step
            anime({
              targets: currentStepElement.querySelectorAll('.grid > div, .field-group'),
              opacity: [0, 1],
              translateY: [20, 0],
              delay: anime.stagger(50, {start: 200}),
              duration: 600,
              easing: 'easeOutQuad'
            });
          }
          
          // Pulse active journey step
          const activeJourneyStep = journeySteps[n-1];
          if (activeJourneyStep) {
            anime({
              targets: activeJourneyStep,
              scale: [1, 1.05, 1],
              duration: 600,
              easing: 'easeInOutQuad'
            });
          }
          
          // Animate checkmarks for completed steps
          for (let i = 0; i < n - 1; i++) {
            const checkmark = journeySteps[i]?.querySelector('.journey-checkmark');
            if (checkmark) {
              anime({
                targets: checkmark,
                scale: [0, 1.2, 1],
                rotate: [0, 360],
                duration: 600,
                delay: i * 100,
                easing: 'easeOutElastic(1, .6)'
              });
            }
          }
        }
        
        // Initialize signature pad on step 5
        if (n === 5 && !sigPad) setTimeout(initSigPad, 50);
        
        // Update print date on final step
        if (n === TOTAL_STEPS) {
          const printDate = document.getElementById('printDate');
          if (printDate) printDate.textContent = new Date().toLocaleString();
        }
        
        // Smooth scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Announce to screen readers
        announceToScreenReader(`Step ${n} of ${TOTAL_STEPS}`);
      }

      function validateStep(n) {
        const stepEl = elements.steps[n-1];
        if (!stepEl) return true;
        
        const required = Array.from(stepEl.querySelectorAll('[required]'));
        let ok = true;
        const errors = [];
        
        // Clear previous errors
        stepEl.querySelectorAll('.field-error, .ring-red-500').forEach(field => {
          field.classList.remove('field-error', 'ring-2', 'ring-red-500');
        });
        
        required.forEach(inp => {
          // Skip if field is hidden
          const visible = inp.offsetParent !== null;
          if (!visible) return;
          
          // Check if parent container is hidden
          const parentDiv = inp.closest('div[id$="Field"]') || inp.closest('div[id*="Details"]');
          if (parentDiv && parentDiv.style.display === 'none') {
            return;
          }
          
          // Validate based on field type
          if (inp.type === 'radio') {
            const radioGroup = stepEl.querySelectorAll(`input[name="${inp.name}"]`);
            const isChecked = Array.from(radioGroup).some(radio => radio.checked);
            if (!isChecked) {
              ok = false;
              errors.push(`Please select a ${inp.name} option`);
            }
          } else if (inp.type === 'checkbox' && inp.hasAttribute('required')) {
            if (!inp.checked) {
              inp.classList.add('field-error');
              ok = false;
            }
          } else if (!String(inp.value || '').trim()) {
            inp.classList.add('ring-2', 'ring-red-500');
            ok = false;
          }
        });
        
        // Special validation for step 5 (signature)
        if (n === 5) {
          const ack = document.getElementById('ack');
          if (ack && !ack.checked) {
            ack.classList.add('field-error');
            ok = false;
            errors.push('Please acknowledge the certification');
          }
          if (sigPad && sigPad.isEmpty()) {
            ok = false;
            errors.push('Please provide a signature');
          }
        }
        
        // Announce validation results
        if (!ok) {
          announceError(`Form validation failed. ${errors.join('. ')}`);
        }
        
        return ok;
      }
      
      // LocalStorage functions
      function saveCurrentStepData() {
        const currentStepElement = elements.steps[currentStep - 1];
        if (!currentStepElement) return;
        
        const inputs = currentStepElement.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          const name = input.name || input.id;
          if (name) {
            if (input.type === 'checkbox') {
              formData[name] = input.checked;
            } else if (input.type === 'radio') {
              if (input.checked) {
                formData[name] = input.value;
              }
            } else if (input.type !== 'file') {
              formData[name] = input.value;
            }
          }
        });
      }
      
      function saveProgress() {
        try {
          saveCurrentStepData();
          
          const progressData = {
            currentStep: currentStep,
            formData: formData,
            timestamp: new Date().toISOString()
          };
          
          localStorage.setItem('cobraInitialFormProgress', JSON.stringify(progressData));
          
          // Show success feedback
          if (elements.saveProgressBtn) {
            const originalText = elements.saveProgressBtn.innerHTML;
            elements.saveProgressBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved!';
            elements.saveProgressBtn.style.backgroundColor = 'var(--accent-green)';
            elements.saveProgressBtn.style.color = 'white';
            
            setTimeout(() => {
              elements.saveProgressBtn.innerHTML = originalText;
              elements.saveProgressBtn.style.backgroundColor = '';
              elements.saveProgressBtn.style.color = '';
            }, 2000);
          }
          
          announceToScreenReader('Progress saved successfully');
        } catch (error) {
          console.error('Error saving progress:', error);
          announceError('Failed to save progress');
        }
      }
      
      function loadSavedProgress() {
        try {
          const saved = localStorage.getItem('cobraInitialFormProgress');
          if (!saved) return;
          
          const progress = JSON.parse(saved);
          if (progress.currentStep && progress.formData) {
            currentStep = Math.min(Math.max(progress.currentStep, 1), TOTAL_STEPS);
            formData = progress.formData;
            
            // Restore form values
            Object.keys(formData).forEach(name => {
              const inputs = document.querySelectorAll(`[name="${name}"]`);
              inputs.forEach(input => {
                if (input.type === 'radio') {
                  input.checked = input.value === formData[name];
                } else if (input.type === 'checkbox') {
                  input.checked = formData[name] === true;
                } else if (input.type !== 'file') {
                  input.value = formData[name] || '';
                }
              });
            });
            
            announceToScreenReader('Previous progress restored');
          }
        } catch (error) {
          console.error('Error loading saved progress:', error);
          localStorage.removeItem('cobraInitialFormProgress');
        }
      }

      // Dependents dynamic list
      const depsContainer = document.getElementById('dependentsContainer');
      document.getElementById('addDepBtn')?.addEventListener('click', () => {
        const id = 'dep_' + Math.random().toString(36).slice(2,8);
        const wrapper = document.createElement('div');
        wrapper.className = 'rounded-lg border-2 border-slate-200 p-3';
        wrapper.innerHTML = `
          <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 items-end">
            <div class="sm:col-span-2">
              <label class="block text-sm text-slate-700">Name</label>
              <input name="dependents[${id}][name]" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm text-slate-700">DOB</label>
              <input type="date" name="dependents[${id}][dob]" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm text-slate-700">Relationship</label>
              <input name="dependents[${id}][rel]" class="mt-1 w-full rounded-md border-2 border-slate-200 px-3 py-2" placeholder="Spouse/Child" />
            </div>
          </div>
          <div class="mt-2 text-right">
            <button type="button" class="text-sm text-red-600 hover:underline" data-remove>Remove</button>
          </div>
        `;
        wrapper.querySelector('[data-remove]')?.addEventListener('click', () => wrapper.remove());
        depsContainer.appendChild(wrapper);
      });

      // Mask SSN: keep only last 4 visible
      const ssnInput = document.getElementById('employee_ssn');
      const ssnHidden = document.getElementById('employee_ssn_last4');
      function maskSSN(value) {
        const digits = (value || '').replace(/\D/g, '').slice(0, 9);
        const last4 = digits.slice(-4);
        if (ssnHidden) ssnHidden.value = last4;
        return last4 ? `***-**-${last4}` : '';
      }
      if (ssnInput) {
        ssnInput.addEventListener('input', (e) => {
          const v = e.target.value;
          const masked = maskSSN(v);
          e.target.value = masked;
        });
        ssnInput.addEventListener('blur', (e) => {
          const v = e.target.value;
          e.target.value = maskSSN(v);
        });
      }

      function gatherPayload() {
        const data = new FormData(form);
        // Gather dependents
        const dependents = [];
        depsContainer.querySelectorAll('input').forEach((inp) => {
          const m = inp.name.match(/dependents\[(.*?)\]\[(name|dob|rel)\]/);
          if (!m) return;
          const id = m[1];
          const key = m[2];
          let dep = dependents.find(d => d.id === id);
          if (!dep) { dep = { id }; dependents.push(dep); }
          dep[key] = inp.value || '';
        });

        const payload = {
          formType: 'cobra_initial_notice',
          submissionTimestamp: new Date().toISOString(),
          employer: {
            employer_name: data.get('employer_name')||'',
            fein: data.get('fein')||'',
            contact_name: data.get('contact_name')||'',
            contact_email: data.get('contact_email')||'',
            contact_phone: data.get('contact_phone')||'',
            notice_date: data.get('notice_date')||''
          },
          beneficiary: {
            employee_name: data.get('employee_name')||'',
            ssn_last4: data.get('employee_ssn_last4')||'',
            dob: data.get('employee_dob')||'',
            email: data.get('employee_email')||'',
            address1: data.get('employee_address1')||'',
            address2: data.get('employee_address2')||'',
            city: data.get('employee_city')||'',
            state: data.get('employee_state')||'',
            zip: data.get('employee_zip')||'',
            dependents: dependents.map(({id, ...rest}) => rest)
          },
          qualifyingEvent: {
            event_type: data.get('event_type')||'',
            event_date: data.get('event_date')||'',
            loss_date: data.get('loss_date')||'',
            max_months: data.get('max_months')||''
          },
          plans: {
            medical: data.get('offer_medical') === 'on' ? {
              carrier: data.get('medical_carrier')||'',
              monthly_premium: data.get('medical_premium')||'',
              admin_pct: data.get('medical_admin_pct')||''
            } : null,
            dental: data.get('offer_dental') === 'on' ? {
              carrier: data.get('dental_carrier')||'',
              monthly_premium: data.get('dental_premium')||'',
              admin_pct: data.get('dental_admin_pct')||''
            } : null,
            vision: data.get('offer_vision') === 'on' ? {
              carrier: data.get('vision_carrier')||'',
              monthly_premium: data.get('vision_premium')||'',
              admin_pct: data.get('vision_admin_pct')||''
            } : null,
            fsa: data.get('offer_fsa') === 'on' ? {
              monthly_premium: data.get('fsa_premium')||'',
              admin_pct: data.get('fsa_admin_pct')||''
            } : null
          },
          billing: {
            initial_due: data.get('initial_due')||'',
            monthly_due_day: data.get('monthly_due_day')||''
          },
          authorization: {
            prepared_by: data.get('prepared_by')||'',
            prepared_title: data.get('prepared_title')||'',
            prepared_date: data.get('prepared_date')||'',
            signature: sigPad && !sigPad.isEmpty() ? sigPad.toDataURL('image/png') : '',
            beneficiary_email_copy: data.get('beneficiary_email_copy')||''
          },
          documents: {
            supporting_count: document.getElementById('file_supporting').files.length
          },
          branding: { primary: '#1E4E6B', secondary: '#A4C639', bg: '#F0F4F0' },
          userAgent: navigator.userAgent
        };
        return payload;
      }

      function collectMultipartForm(payload) {
        const fd = new FormData();
        fd.append('payload', new Blob([JSON.stringify(payload)], { type: 'application/json' }));
        const supporting = document.getElementById('file_supporting').files;
        if (supporting && supporting.length) {
          Array.from(supporting).forEach((f, i) => fd.append('supporting_'+i, f));
        }
        return fd;
      }

      async function submitToWebhook() {
        const webhookUrl = 'https://n8n.nuesynergy.webhook.1234';
        const payload = gatherPayload();
        const multipart = collectMultipartForm(payload);

        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 30000);
          const res = await fetch(webhookUrl, { method: 'POST', body: multipart, signal: controller.signal });
          clearTimeout(timeout);
          if (!res.ok) throw new Error('HTTP '+res.status);
          return true;
        } catch (err) {
          try {
            // Fallback: post JSON payload to a hidden iframe to avoid navigating away
            const iframeName = 'hidden_iframe_' + Date.now();
            const iframe = document.createElement('iframe');
            iframe.name = iframeName;
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            const f = document.createElement('form');
            f.method = 'POST';
            f.action = webhookUrl;
            f.enctype = 'application/x-www-form-urlencoded';
            f.target = iframeName;
            f.style.display = 'none';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'payload';
            input.value = JSON.stringify(payload);
            f.appendChild(input);

            document.body.appendChild(f);
            f.submit();

            setTimeout(() => {
              try { document.body.removeChild(f); } catch {}
              try { document.body.removeChild(iframe); } catch {}
            }, 3000);

            return true;
          } catch (fallbackErr) {
            console.error('Fallback submission failed:', fallbackErr);
            return false;
          }
        }
      }

      function summarize(payload) {
        const el = document.getElementById('submissionSummary');
        el.innerHTML = `
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
            <div><strong>Employer:</strong> ${payload.employer.employer_name || 'N/A'}</div>
            <div><strong>Notice Date:</strong> ${payload.employer.notice_date || 'N/A'}</div>
            <div><strong>Beneficiary:</strong> ${payload.beneficiary.employee_name || 'N/A'}</div>
            <div><strong>Event:</strong> ${payload.qualifyingEvent.event_type || 'N/A'} on ${payload.qualifyingEvent.event_date || 'N/A'}</div>
          </div>
        `;
      }

      // Success animation with confetti
      function showSuccessAnimation() {
        if (typeof anime === 'undefined') return;
        
        // Confetti animation
        for (let i = 0; i < 30; i++) {
          const particle = document.createElement('div');
          particle.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${i % 2 === 0 ? '#1E4E6B' : '#A4C639'};
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            top: 50%;
            left: 50%;
          `;
          document.body.appendChild(particle);
          
          anime({
            targets: particle,
            translateX: anime.random(-400, 400),
            translateY: [0, anime.random(300, 800)],
            opacity: [1, 0],
            scale: [1, 0],
            rotate: anime.random(0, 720),
            duration: anime.random(1500, 2500),
            easing: 'easeOutQuad',
            complete: () => particle.remove()
          });
        }
      }
      
      // Initialize animations on page load
      function initAnimeAnimations() {
        if (typeof anime === 'undefined') return;
        
        // Animate header (already has CSS animation, this is backup)
        anime({
          targets: 'header.animate-in',
          opacity: [0, 1],
          translateY: [-30, 0],
          duration: 1200,
          easing: 'easeOutExpo'
        });
        
        // Animate journey tracker container
        anime({
          targets: 'nav[aria-label="Form progress"]',
          opacity: [0, 1],
          translateY: [30, 0],
          duration: 1000,
          delay: 300,
          easing: 'easeOutExpo'
        });
        
        // Animate journey step cards with stagger
        anime({
          targets: '.journey-step',
          opacity: [0, 1],
          translateY: [30, 0],
          scale: [0.9, 1],
          delay: anime.stagger(80, {start: 600}),
          duration: 800,
          easing: 'easeOutElastic(1, .6)'
        });
      }
      
      // Navigation button event handlers
      elements.prevBtn.addEventListener('click', () => {
        if (currentStep > 1) {
          saveCurrentStepData();
          currentStep -= 1;
          showStep(currentStep);
          announceToScreenReader(`Moved back to step ${currentStep}`);
        }
      });

      elements.nextBtn.addEventListener('click', async () => {
        if (!validateStep(currentStep)) {
          alert('Please complete required fields before continuing.');
          const firstError = elements.steps[currentStep - 1].querySelector('.field-error, .ring-red-500');
          if (firstError) firstError.focus();
          return;
        }
        
        saveCurrentStepData();
        
        if (currentStep === TOTAL_STEPS - 1) {
          // Submit the form
          elements.nextBtn.disabled = true;
          elements.nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
          
          announceToScreenReader('Submitting form, please wait...');
          
          try {
            const ok = await submitToWebhook();
            const data = gatherPayload();
            summarize(data);
            
            if (ok) {
              showSuccessAnimation();
              // Clear saved progress
              localStorage.removeItem('cobraInitialFormProgress');
            }
            
            currentStep = TOTAL_STEPS;
            showStep(currentStep);
            announceToScreenReader('Form submitted successfully');
          } catch (error) {
            console.error('Submission error:', error);
            announceError('Form submission failed. Please try again.');
            alert('Form submission failed. Please try again.');
          } finally {
            elements.nextBtn.disabled = false;
            elements.nextBtn.innerHTML = 'Next<i class="fas fa-arrow-right ml-2"></i>';
          }
          return;
        }
        
        currentStep += 1;
        showStep(currentStep);
      });
      
      // Save progress button
      if (elements.saveProgressBtn) {
        elements.saveProgressBtn.addEventListener('click', saveProgress);
      }

      document.getElementById('downloadJsonBtn')?.addEventListener('click', async () => {
        const data = gatherPayload();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cobra-initial-notice-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      document.getElementById('startOverBtn')?.addEventListener('click', () => {
        if (!confirm('Start a new notice? This will clear the current data and saved progress.')) return;
        
        // Reset form
        elements.form.reset();
        if (sigPad) sigPad.clear();
        document.getElementById('dependentsContainer').innerHTML = '';
        
        // Clear saved data
        formData = {};
        localStorage.removeItem('cobraInitialFormProgress');
        
        // Reset to step 1
        currentStep = 1;
        showStep(currentStep);
        
        // Re-set default dates
        const today = new Date().toISOString().split('T')[0];
        const preparedDate = elements.form.querySelector('input[name="prepared_date"]');
        if (preparedDate) preparedDate.value = today;
        const noticeDate = elements.form.querySelector('input[name="notice_date"]');
        if (noticeDate) noticeDate.value = today;
        
        announceToScreenReader('Form reset to beginning');
      });

      // Initialize on page load
      function init() {
        try {
          // Load saved progress
          loadSavedProgress();
          
          // Set default dates
          const today = new Date().toISOString().split('T')[0];
          const preparedDate = elements.form.querySelector('input[name="prepared_date"]');
          if (preparedDate && !preparedDate.value) preparedDate.value = today;
          const noticeDate = elements.form.querySelector('input[name="notice_date"]');
          if (noticeDate && !noticeDate.value) noticeDate.value = today;

          // Show current step
          showStep(currentStep);
          
          // Initialize animations
          initAnimeAnimations();
          
          // Announce to screen readers
          announceToScreenReader('COBRA Initial Notice form loaded and ready');
        } catch (error) {
          console.error('Error initializing form:', error);
          announceError('Form initialization failed');
        }
      }
      
      // Run initialization when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
